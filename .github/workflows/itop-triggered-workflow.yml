name: Ka0s iTop Triggered Workflow

on:
  workflow_dispatch:
    inputs:
      itop_ticket_id:
        description: 'ID del ticket de iTop'
        required: true
        default: 'N/A'
      requester_name:
        description: 'Nombre del solicitante'
        required: true
        default: 'Ka0sC0re'

jobs:
  job-core:
    runs-on: swarm-runners-scaleset
    outputs:
      status: ${{ job.status }}
    steps:
      - name: Print iTop Data
        run: |
          echo "Workflow iniciado desde iTop."
          echo "ID del Ticket: ${{ github.event.inputs.itop_ticket_id }}"
          echo "Solicitante: ${{ github.event.inputs.requester_name }}"

      - name: Checkout code
        uses: actions/checkout@v4

      # Este es el paso principal de la automatización.
      # Si este paso falla, el job 'update-itop' lo reflejará en el ticket.
      - name: Run automation script
        id: automation
        run: |
          echo "Ejecutando la tarea automatizada..."
          # Simula un fallo para probar la lógica de error. Elimina o comenta la siguiente línea para probar el éxito.
          # exit 1

  update-itop:
    runs-on: swarm-runners-scaleset
    needs: job-core
    if: always() # Se ejecuta siempre, para poder reportar tanto éxito como fallo.
    steps:
      - name: Update iTop on Success
        if: needs.job-core.outputs.status == 'success'
        run: |
          curl -k -X POST '${{ secrets.ITOP_URL }}/webservices/rest.php?version=1.3' \
            -H 'Content-Type: application/json' \
            -d '{
              "operation": "core/update",
              "class": "UserRequest",
              "key": "${{ github.event.inputs.itop_ticket_id }}",
              "output_fields": "ref",
              "auth_user": "${{ secrets.ITOP_API_USER }}",
              "auth_pwd": "${{ secrets.ITOP_API_PASSWORD }}",
              "fields": {
                "status": "resolved",
                "solution": "Solución provista por Asistencia. El workflow se ha ejecutado correctamente."
              }
            }'

      - name: Update iTop on Failure
        if: needs.job-core.outputs.status == 'failure'
        run: |
          curl -k -X POST '${{ secrets.ITOP_URL }}/webservices/rest.php?version=1.3' \
            -H 'Content-Type: application/json' \
            -d '{
              "operation": "core/update",
              "class": "UserRequest",
              "key": "${{ github.event.inputs.itop_ticket_id }}",
              "output_fields": "ref",
              "auth_user": "${{ secrets.ITOP_API_USER }}",
              "auth_pwd": "${{ secrets.ITOP_API_PASSWORD }}",
              "fields": {
                "solution": "Solución provista por Asistencia. El workflow ha fallado."
              }
            }'
