name: iTop Create API User

on:
  workflow_dispatch:
    inputs:
      target_login:
        description: "Login del usuario a crear"
        required: false
        default: "itop_api_integration"
      target_first_name:
        description: "Nombre"
        required: false
        default: "API"
      target_last_name:
        description: "Apellido"
        required: false
        default: "Integration"
      target_email:
        description: "Email (opcional, recomendado para reconciliación)"
        required: false
        default: ""
      target_org_name:
        description: "Organización existente en iTop (Organization.name)"
        required: true
      target_profiles:
        description: "Perfiles separados por coma (incluye REST Services User)"
        required: false
        default: "REST Services User"
      target_language:
        description: "Idioma (ej: EN US)"
        required: false
        default: "EN US"
      update_password:
        description: "Actualizar password si el usuario ya existe (true/false)"
        required: false
        default: "false"

jobs:
  create-api-user:
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create iTop API user
        env:
          ITOP_URL: ${{ secrets.ITOP_URL || vars.ITOP_URL }}
          ITOP_USER: ${{ secrets.ITOP_API_USER }}
          ITOP_PASSWORD: ${{ secrets.ITOP_API_PASSWORD }}

          ITOP_TARGET_LOGIN: ${{ github.event.inputs.target_login }}
          ITOP_TARGET_PASSWORD: ${{ secrets.ITOP_TARGET_PASSWORD }}
          ITOP_TARGET_FIRST_NAME: ${{ github.event.inputs.target_first_name }}
          ITOP_TARGET_LAST_NAME: ${{ github.event.inputs.target_last_name }}
          ITOP_TARGET_EMAIL: ${{ github.event.inputs.target_email }}
          ITOP_TARGET_ORG_NAME: ${{ github.event.inputs.target_org_name }}
          ITOP_TARGET_PROFILES: ${{ github.event.inputs.target_profiles }}
          ITOP_TARGET_LANGUAGE: ${{ github.event.inputs.target_language }}
          ITOP_UPDATE_PASSWORD: ${{ github.event.inputs.update_password }}
        run: python3 devops/core/itop/create-itop-api-user.py
