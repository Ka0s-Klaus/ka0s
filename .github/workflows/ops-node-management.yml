name: Ops - Node Management
on:
  workflow_dispatch:
    inputs:
      node_name:
        description: 'Nombre del nodo'
        required: true
        default: 'k8-node-30'
        type: choice
        options:
        - k8-node-20
        - k8-node-30
        - k8-node-40
      action:
        description: 'Acción a realizar'
        required: true
        type: choice
        options:
        - 'taint-restricted'   # Aplica restricted=true:NoSchedule
        - 'untaint-restricted' # Elimina restricted=true:NoSchedule
        - 'cordon'            # Marca como Unschedulable
        - 'uncordon'          # Marca como Schedulable

permissions:
  contents: read
  actions: write
  issues: write

env:
  KAOS_MODULE: "[Ka0S] Ops Node Management"

jobs:
  manage-node:
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Kubectl Tunnel
        uses: ./.github/actions/kubectl-tunnel
        with:
          host: ${{ secrets.KAOS_SSH_HOST_1 }}
          username: ${{ secrets.KAOS_SSH_USER }}
          key: ${{ secrets.KAOS_SSH_KEY_PRIV }}
          port: ${{ secrets.KAOS_SSH_PORT_1 }}

      - name: Execute Node Operation
        run: |
          NODE="${{ inputs.node_name }}"
          ACTION="${{ inputs.action }}"
          
          echo "Processing Node: $NODE with Action: $ACTION"
          
          if [ "$ACTION" == "taint-restricted" ]; then
            # Aplicamos un Taint para que solo los pods con la toleration puedan usuarlo
            # key=restricted, value=true, effect=NoSchedule
            kubectl taint nodes $NODE restricted=true:NoSchedule --overwrite
            echo "✅ Node $NODE tainted with restricted=true:NoSchedule"
            echo "ℹ️  To use this node, add this toleration to your pod:"
            echo "    tolerations:"
            echo "    - key: \"restricted\""
            echo "      operator: \"Equal\""
            echo "      value: \"true\""
            echo "      effect: \"NoSchedule\""
            
          elif [ "$ACTION" == "untaint-restricted" ]; then
            kubectl taint nodes $NODE restricted=true:NoSchedule- || true
            echo "✅ Node $NODE untainted"
            
          elif [ "$ACTION" == "cordon" ]; then
            kubectl cordon $NODE
            echo "✅ Node $NODE cordoned (SchedulingDisabled)"
            
          elif [ "$ACTION" == "uncordon" ]; then
            kubectl uncordon $NODE
            echo "✅ Node $NODE uncordoned (SchedulingEnabled)"
          fi
          
          echo "--- Current Node Status ---"
          kubectl get nodes -o wide

  handle-success:
    name: Handle Success
    needs: [manage-node]
    if: success()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Log Success
        run: echo "Node management operation completed successfully."

  handle-failure:
    name: Handle Failure
    needs: [manage-node, handle-success]
    if: failure()
    runs-on: swarm-runners-scaleset
    steps:
      - id: repo
        name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Create Incident Issue
        env:
          GH_TOKEN: ${{ secrets.KAOS_REPO_TOKEN }}
        run: |
          gh issue create \
            --title "[INCIDENT]: Fallo en workflow ${{ github.workflow }}" \
            --label "itop-incident,triage,automated" \
            --body "### Organización
          Ka0s
          
          ### Solicitante
          @${{ github.actor }}
          
          ### Estado
          New
          
          ### Impacto
          Service
          
          ### Urgencia
          Medium
          
          ### Servicio / CI afectado
          GitHub Actions / ${{ github.workflow }}
          
          ### Descripción
          El workflow **${{ github.workflow }}** ha fallado durante su ejecución.
          
          **Detalles Técnicos:**
          - **Módulo**: ${{ env.KAOS_MODULE }}
          - **Run ID**: ${{ github.run_id }}
          - **Commit**: ${{ github.sha }}
          - **Branch/Ref**: ${{ github.ref_name }}
          - **Actor**: ${{ github.actor }}
          
          ### Pasos / Evidencias
          Logs de ejecución: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          "

  end-workflow:
    needs: [handle-success, handle-failure]
    if: always()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Trigger Inspector
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run inspector.yml \
            -f workflow_name="${{ github.workflow }}" \
            -f run_id="${{ github.run_id }}" \
            -f status="${{ job.status }}"
