name: Ka0s Secrets Audit

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  secrets-audit:
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install gh CLI
        uses: ./.github/actions/install-gh-cli

      - name: Compute unused repository secrets
        env:
          GH_TOKEN: ${{ secrets.KAOS_ACTIONS_TOKEN }}
        run: |
          set -euo pipefail

          echo "Listing defined repository secrets..."
          gh api \
            repos/${GITHUB_REPOSITORY}/actions/secrets \
            --paginate \
            --jq '.secrets[].name' | sort -u > /tmp/defined-secrets.txt

          echo "Extracting secrets used in workflows..."
          rg -o --no-heading 'secrets\.([A-Z0-9_]+)' .github/workflows \
            | sed 's/.*secrets\.//' \
            | sort -u > /tmp/used-secrets.txt || true

          echo
          echo "## Secrets definidos en el repositorio"
          cat /tmp/defined-secrets.txt || true

          echo
          echo "## Secrets usados en workflows (.github/workflows)"
          if [ -s /tmp/used-secrets.txt ]; then
            cat /tmp/used-secrets.txt
          else
            echo "(ninguno detectado)"
          fi

          echo
          echo "## Secrets definidos pero sin uso detectado en workflows"
          comm -23 /tmp/defined-secrets.txt /tmp/used-secrets.txt || true
