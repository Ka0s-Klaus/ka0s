name: "Ka0s Audit Failed Pods -> iTop"

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *' # Ejecutar cada 30 minutos

permissions:
  contents: write
  actions: write
  issues: write

env:
  KAOS_MODULE: "[Ka0S] Audit Pods"
  KAOS_CODE: ${{ github.run_id }}

jobs:
  audit-pods:
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Execute Audit Script
        uses: ./.github/actions/ssh-exec
        with:
          host: ${{ secrets.KAOS_SSH_HOST_1 }}
          username: ${{ secrets.KAOS_SSH_USER }}
          key: ${{ secrets.KAOS_SSH_KEY_PRIV }}
          port: ${{ secrets.KAOS_SSH_PORT_1 }}
          use-sudo: true # Requerido para acceso a kubeconfig admin si aplica
          pass: ${{ secrets.KAOS_SSH_PASS }}
          script-path: 'devops/core/k8s/audit-failed-pods.sh'
          remote-results-path: '/tmp/results'
          local-results-path: 'audit/kube/'

      - name: Commit Results
        if: success()
        run: |
          git config --global user.name "${{ secrets.KAOS_BOT_NAME || 'Ka0s Bot' }}"
          git config --global user.email "${{ secrets.KAOS_BOT_EMAIL || 'bot@ka0s.io' }}"
          git pull
          git add audit/kube/failed_pods.json audit/itop/ || true
          if ! git diff --staged --quiet; then
            git commit -m "[Audit] Update failed pods and iTop reconciliation report $(date +'%Y-%m-%d %H:%M')"
            git push
          else
            echo "No changes in failed pods or iTop reconciliation reports."
          fi

      - name: Check iTop connectivity
        if: success()
        env:
          ITOP_URL: ${{ secrets.ITOP_URL || vars.ITOP_URL }}
        run: |
          echo "Checking connectivity to $ITOP_URL/webservices/rest.php?version=1.3"
          curl --silent --show-error --fail --insecure --max-time 10 "$ITOP_URL/webservices/rest.php?version=1.3" || exit 1

      - name: Process Tickets in iTop
        if: success()
        env:
          ITOP_URL: ${{ secrets.ITOP_URL || vars.ITOP_URL }}
          ITOP_USER: ${{ secrets.ITOP_API_USER }}
          ITOP_PASSWORD: ${{ secrets.ITOP_API_PASSWORD }}
          ITOP_ORIGIN: ${{ secrets.ITOP_ORIGIN || vars.ITOP_ORIGIN || 'Ka0s Inc' }}
          FAILED_PODS_FILE: 'audit/kube/failed_pods.json'
          ITOP_AUDIT_OUTPUT_DIR: 'audit/itop'
        run: python3 devops/core/k8s/process-failed-pods.py

  handle-success:
    runs-on: swarm-runners-scaleset
    needs: [audit-pods]
    if: ${{ success() }}
    steps: 
      - id: handle-success-execution
        run: |
          echo "${{ env.KAOS_MODULE }} Success in runid ${{ github.run_id }} initiated."
          
  handle-failure:
    runs-on: swarm-runners-scaleset
    needs: [audit-pods]
    if: ${{ failure() }} 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Create Failure Issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue create \
            --title "${{ env.KAOS_MODULE }} Error detected in ${{ env.KAOS_CODE }}" \
            --label "bug" \
            --body "Error detected in ${{ env.KAOS_MODULE }}. Please check the logs and audit files: Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}; Failed pods report: audit/kube/failed_pods.json; iTop reconciliation (if generated): audit/itop/."
            
  end-workflow:
    needs: [handle-success, handle-failure]
    if: always()
    runs-on: swarm-runners-scaleset
    steps:
      - id: repo
        name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
        
      - name: Trigger Inspector
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîç Triggering Inspector for Audit..."
          gh workflow run inspector.yml \
            --ref main \
            -f kaos-workflow-id="${{ github.run_id }}" \
            -f kaos-user-start="${{ github.triggering_actor }}"
