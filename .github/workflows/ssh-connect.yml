name: Ka0s C0re SSH Host Connect
on:
  workflow_dispatch:
    inputs:
      script-path:
        description: 'Path of the script to execute'
        required: true
        default: 'devops/core/host/test.sh'
      script-args:
        description: 'Arguments for the script'
        required: false
        default: ''
      results-path:
        description: 'Path in the repository to store results'
        required: false
        default: 'audit/eresults/'

  schedule:
    - cron: '0 22 * * *'  # Run daily at midnight at UTC

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

env:
  KAOS_MODULE: "[Ka0S] Audit Host"
  KAOS_PATH_RESUME: ${{ github.event.inputs.results-path || 'audit/eresults/' }}
  KAOS_FILE_HOST: ${{ github.run_id }}
  KAOS_CODE: ${{ github.run_id }}

jobs:
  job-core:
    runs-on: swarm-runners-scaleset
    outputs:
      results_path: ${{ steps.audit.outputs.results-path }}
    steps:
      - id: repo
        name: Checkout repository
        if: ${{ success() }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: audit
        name: Execute audit script
        uses: ./.github/actions/ssh-exec
        with:
          host: ${{ secrets.KAOS_SSH_HOST_1 }}
          username: ${{ secrets.KAOS_SSH_USER }}
          key: ${{ secrets.KAOS_SSH_KEY_PRIV }}
          port: ${{ secrets.KAOS_SSH_PORT_1 }}
          pass: ${{ secrets.KAOS_SSH_PASS }}
          use-sudo: true
          script-path: ${{ github.event.inputs.script-path || 'devops/core/host/test.sh' }}
          script-args: ${{ github.event.inputs.script-args || '' }}
          remote-results-path: '/tmp/results/' # Ruta de ejemplo en el host remoto
          local-results-path: '${{ env.KAOS_PATH_RESUME }}' # Ruta en el runner donde se copiar√°n los resultados

      - name: Upload audit results
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: audit-results
          path: ${{ env.KAOS_PATH_RESUME }}

  commit-results:
    runs-on: swarm-runners-scaleset
    needs: [job-core]
    if: success() && needs.job-core.outputs.results_path != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download audit results
        uses: actions/download-artifact@v4
        with:
          name: audit-results
          path: ${{ env.KAOS_PATH_RESUME }}

      - name: Commit and push results
        run: |
          echo "Uploading files to Audit update repository..."
          git config --global user.name "${{ secrets.KAOS_BOT_NAME }}"
          git config --global user.email "${{ secrets.KAOS_BOT_EMAIL }}"
          git add ${{ env.KAOS_PATH_RESUME }}/*
          if ! git diff --staged --quiet; then
             git commit -m "[Ka0S] Uploading audit results for run ${{ github.run_id }}"
             git push origin ${{ github.ref }}
          else
             echo "No changes to commit."
          fi

  handle-success:
    runs-on: swarm-runners-scaleset
    needs: [job-core, commit-results]
    if: ${{ success() }}
    steps: 
      - id: handle-success-execution
        run: |
          # Subimos el fichero de auditoria
          echo "${{ env.KAOS_MODULE }} Success in runid ${{ github.run_id }} initiated."
          # echo "Uploading files to Audit update repository ..."
          # git config --global user.name "${{ secrets.KAOS_BOT_NAME }}"
          # git config --global user.email "${{ secrets.KAOS_BOT_EMAIL }}"
          # git add ${{ env.KAOS_PATH_RESUME }}
          # if ! git diff --staged --quiet; then
          #    git commit -m "Ka0S] Uploading files to udit update repository ..."
          #    git push origin ${{ github.ref }} --force-with-lease
          # fi
          
  handle_failure:
      runs-on: swarm-runners-scaleset
      needs: [job-core]
      if: ${{ failure() }} 
      steps: 
        - id: check-execution
          run: |
            # si ha existido un error dejamos la tarjeta In Review
            echo "Error detected in ${{ env.KAOS_MODULE }}, creating issue..."
            
  end-workflow:
    runs-on: swarm-runners-scaleset
    needs: [job-core, handle-success, handle_failure, commit-results]
    if: ${{ always() }} 
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - id: repo
        name: Checkout code
        if: ${{ always() }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # token: ${{ secrets.KAOS_REPO_TOKEN }}

      # con esta parte suplimos que la imagen no disponga de la cli de GH    
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli

      - id: end-process
        name: Finaliza el workflow
        run: |
          echo "End process"
          gh workflow run inspector.yml --ref ${{ github.ref }} -f kaos-workflow-id="${{ env.KAOS_CODE }}"
