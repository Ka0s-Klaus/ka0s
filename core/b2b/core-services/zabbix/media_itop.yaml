zabbix_export:
  version: '7.0'
  media_types:
    - name: iTop
      type: WEBHOOK
      parameters:
        - name: alert_message
          value: '{ALERT.MESSAGE}'
        - name: alert_subject
          value: '{ALERT.SUBJECT}'
        - name: event_id
          value: '{EVENT.ID}'
        - name: event_nseverity
          value: '{EVENT.NSEVERITY}'
        - name: event_recovery_value
          value: '{EVENT.RECOVERY.VALUE}'
        - name: event_source
          value: '{EVENT.SOURCE}'
        - name: event_tags
          value: '{EVENT.TAGS}'
        - name: event_update_action
          value: '{EVENT.UPDATE.ACTION}'
        - name: event_update_message
          value: '{EVENT.UPDATE.MESSAGE}'
        - name: event_update_status
          value: '{EVENT.UPDATE.STATUS}'
        - name: event_value
          value: '{EVENT.VALUE}'
        - name: itop_api_version
          value: '1.3'
        - name: itop_class
          value: UserRequest
        - name: itop_comment
          value: 'Created by Zabbix'
        - name: itop_id
          value: '{EVENT.TAGS.__zbx_itop_id}'
        - name: itop_log
          value: private_log
        - name: itop_organization_id
          value: '1'
        - name: itop_password
          value: 'zabbix'
        - name: itop_url
          value: 'https://itop.itop.svc.cluster.local'
        - name: itop_user
          value: 'zabbix'
        - name: trigger_id
          value: '{TRIGGER.ID}'
        - name: zabbix_url
          value: '{$ZABBIX.URL}'
      script: |
        var Itop = {
            params: {},
        
            setParams: function (params) {
                if (typeof params !== 'object') {
                    return;
                }
        
                if (params.itop_user === '<PLACEHOLDER>' || params.itop_password === '<PLACEHOLDER>' || params.itop_url === '<PLACEHOLDER>') {
                    throw 'Required parameters is not set: "itop_user", "itop_password" or "itop_url".';
                }
        
                Itop.params = params;
                if (typeof Itop.params.itop_organization_id === 'undefined' || Itop.params.itop_organization_id === '') {
                    throw 'Required parameter is not set: "itop_organization_id".';
                }
                if (!Itop.params.itop_url.endsWith('/')) {
                    Itop.params.itop_url += '/';
                }
            },
        
            setProxy: function (HTTPProxy) {
                Itop.HTTPProxy = HTTPProxy;
            },
        
            request: function (data, comment) {
                var response,
                    url = Itop.params.itop_url + 'webservices/rest.php',
                    request = new HttpRequest();
        
                if (typeof Itop.HTTPProxy !== 'undefined' && Itop.HTTPProxy !== '') {
                    request.setProxy(Itop.HTTPProxy);
                }
        
                request.addHeader('Content-Type: application/x-www-form-urlencoded');
                data = JSON.stringify(data);
        
                Zabbix.log(4, '[ iTop Webhook ] Sending request: ' + url + '&version=' + Itop.params.itop_api_version + '&auth_user=' + Itop.params.itop_user + '&auth_pwd=********' + '&json_data=' + data);
        
                response = request.post(url, 'version=' + Itop.params.itop_api_version + '&auth_user=' + Itop.params.itop_user + '&auth_pwd=' + encodeURIComponent(Itop.params.itop_password) + '&json_data=' + encodeURIComponent(data));
        
                Zabbix.log(4, '[ iTop Webhook ] Received response with status code ' + request.getStatus() + '\n' + response);
        
                if (response !== null) {
                    try {
                        response = JSON.parse(response);
                    }
                    catch (error) {
                        Zabbix.log(4, '[ iTop Webhook ] Failed to parse response.');
                        response = null;
                    }
                }
        
                if (request.getStatus() < 200 || request.getStatus() >= 300) {
                    var message = 'Request failed with status code ' + request.getStatus();
        
                    if (response !== null && typeof response.message !== 'undefined') {
                        message += ': ' + response.message;
                    }
        
                    throw message;
                }
        
                if (response !== null && typeof response.code !== 'undefined' && response.code !== 0) {
                    var message = 'Request failed with iTop code ' + response.code;
        
                    if (typeof response.message !== 'undefined') {
                        message += ': ' + response.message;
                    }
        
                    throw message;
                }
        
                if (comment && response.objects === null) {
                   return;
                }
        
                if (response === null || typeof response.objects === 'undefined' || Object.keys(response.objects).length === 0) {
                    throw 'Itop response is empty.';
                }
        
                return response;
            },
        
            createObject: function (json_data) {
                var data = {
                    operation: 'core/create',
                    comment: Itop.params.itop_comment,
                    class: Itop.params.itop_class,
                    output_fields: 'id',
                    fields: json_data
                };
        
                return Itop.request(data);
            },
        
            updateObject: function (id, json_data) {
                var data = {
                    operation: 'core/update',
                    comment: Itop.params.itop_comment,
                    class: Itop.params.itop_class,
                    key: id,
                    output_fields: 'id',
                    fields: json_data
                };
        
                Itop.request(data, true);
            },
        
            getField: function (data, name) {
                var value = data.match(new RegExp('^' + name + ': (.*)$', 'm'));
                return value !== null ? value[1] : '';
            }
        };
        
        try {
            var params = JSON.parse(value),
                json_data = {},
                itop_id = params.itop_id,
                severity = [
                    { name: 'not_classified', color: '#97AAB3' },
                    { name: 'information', color: '#7499FF' },
                    { name: 'warning', color: '#FFC859' },
                    { name: 'average', color: '#FFA059' },
                    { name: 'high', color: '#E97659' },
                    { name: 'disaster', color: '#E45959' },
                    { name: 'resolved', color: '#009900' },
                    { name: 'default', color: '#000000' }
                ];
        
            Itop.setParams(params);
            Itop.setProxy(params.HTTPProxy);
        
            // Update
            if (params.event_source === '0' && (params.event_value === '0' || params.event_update_status === '1')) {
                if (itop_id === '{EVENT.TAGS.__zbx_itop_id}') {
                    throw 'Incorrect iTop ID.';
                }
                
                var log_entry = '';
                
                if (params.event_value === '0') {
                    log_entry = 'Problem has been resolved at ' + params.event_recovery_value + ' with status: ' + severity[6].name;
                } else if (params.event_update_status === '1') {
                    log_entry = 'Problem has been updated at ' + params.event_update_action + ' with message: ' + params.event_update_message;
                }
        
                json_data[params.itop_log] = {
                    add_item: {
                        message: log_entry,
                        format: 'text'
                    }
                };
        
                Itop.updateObject(itop_id, json_data);
                return 'OK';
            }
        
            // Create
            if (params.event_source === '0' && params.event_value === '1') {
                var description = 'Event ID: ' + params.event_id + '\n';
                description += 'Event tags: ' + params.event_tags + '\n';
                description += 'Event details: ' + params.alert_message;

                // Logic to determine Class based on specific tags in Subject
                if (params.alert_subject.toLowerCase().indexOf('problem') !== -1) {
                    Itop.params.itop_class = 'Problem';
                } else {
                    Itop.params.itop_class = 'Incident';
                }
        
                json_data.org_id = params.itop_organization_id;
                json_data.title = params.alert_subject;
                json_data.description = description;
                json_data.caller_id = {
                    name: 'Zabbix',
                    first_name: 'Integration'
                };
                json_data.impact = 2; // Medium
                json_data.urgency = 2; // Medium
        
                var result = Itop.createObject(json_data);
                
                var objects = Object.keys(result.objects);
                return JSON.stringify({
                    tags: {
                        __zbx_itop_id: result.objects[objects[0]].fields.id
                    }
                });
            }
        }
        catch (error) {
            Zabbix.log(3, '[ iTop Webhook ] ERROR: ' + error);
            throw 'Sending failed: ' + error;
        }
      description: |
        Please refer to https://www.zabbix.com/documentation/7.0/manual/config/notifications/media/webhook#itop
        
        Set itop_user, itop_password, itop_url and itop_organization_id in the media type parameters.
      message_templates:
        - event_source: TRIGGERS
          operation_mode: PROBLEM
          subject: '[{EVENT.STATUS}] {EVENT.NAME}'
          message: |
            Problem started at {EVENT.TIME} on {EVENT.DATE}
            Problem name: {EVENT.NAME}
            Host: {HOST.NAME}
            Severity: {EVENT.SEVERITY}
            Operational data: {EVENT.OPDATA}
            Original problem ID: {EVENT.ID}
            {TRIGGER.URL}
        - event_source: TRIGGERS
          operation_mode: RECOVERY
          subject: '[{EVENT.STATUS}] {EVENT.NAME}'
          message: |
            Problem has been resolved at {EVENT.RECOVERY.TIME} on {EVENT.RECOVERY.DATE}
            Problem name: {EVENT.NAME}
            Host: {HOST.NAME}
            Severity: {EVENT.SEVERITY}
            Original problem ID: {EVENT.ID}
            {TRIGGER.URL}
        - event_source: TRIGGERS
          operation_mode: UPDATE
          subject: '[{EVENT.STATUS}] {EVENT.NAME}'
          message: |
            {USER.FULLNAME} {EVENT.UPDATE.ACTION} problem at {EVENT.UPDATE.DATE} {EVENT.UPDATE.TIME}.
            {EVENT.UPDATE.MESSAGE}
            
            Current problem status is {EVENT.STATUS}, acknowledged: {EVENT.ACK.STATUS}.
