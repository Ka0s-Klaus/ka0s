apiVersion: apps/v1
kind: Deployment
metadata:
  name: itop
  namespace: itop
  labels:
    app: itop
    core.kaos.io/type: finops
spec:
  replicas: 1
  selector:
    matchLabels:
      app: itop
  template:
    metadata:
      labels:
        app: itop
    spec:
      initContainers:
        - name: init-itop-files
          image: vbkunin/itop:latest-base
          command: ['sh', '-c', 'cp -r /var/www/html/. /web-data/ && chown -R 33:33 /web-data']
          volumeMounts:
            - name: itop-web-persistent-storage
              mountPath: /web-data
        - name: fix-itop-app-root-url
          image: vbkunin/itop:latest-base
          command:
            - sh
            - -c
            - |
              set -e
              CONFIG="/web-data/conf/production/config-itop.php"
              if [ -f "$CONFIG" ]; then
                cat > /tmp/fix-itop-url.php <<'PHP'
                <?php
                $path = '/web-data/conf/production/config-itop.php';
                if (!file_exists($path)) { exit(0); }
                $content = file_get_contents($path);

                $pattern = "/'app_root_url'\\s*=>\\s*[^,]*,/m";
                $replacement = "'app_root_url' => (isset(\$_SERVER['HTTP_X_FORWARDED_PROTO']) ? \$_SERVER['HTTP_X_FORWARDED_PROTO'] : ((isset(\$_SERVER['HTTPS']) && \$_SERVER['HTTPS'] !== 'off') ? 'https' : 'http')).'://'.(isset(\$_SERVER['HTTP_HOST']) ? \$_SERVER['HTTP_HOST'] : 'localhost').((isset(\$_SERVER['HTTP_X_FORWARDED_PREFIX']) && \$_SERVER['HTTP_X_FORWARDED_PREFIX'] !== '') ? rtrim(\$_SERVER['HTTP_X_FORWARDED_PREFIX'], '/').'/' : '/'),";

                $new = preg_replace($pattern, $replacement, $content, 1, $count);
                if ($count === 0) { exit(0); }
                file_put_contents($path, $new);
                PHP
                php /tmp/fix-itop-url.php
                rm -f /tmp/fix-itop-url.php
              fi
          volumeMounts:
            - name: itop-web-persistent-storage
              mountPath: /web-data
      containers:
        - name: itop
          image: vbkunin/itop:latest-base
          ports:
            - containerPort: 80
          env:
            - name: ITOP_DB_HOST
              value: "mysql"
            - name: ITOP_DB_NAME
              value: "itop"
            - name: ITOP_DB_USER
              value: "admin"
            - name: ITOP_DB_PASSWORD
              value: "admin"
          volumeMounts:
            - name: itop-web-persistent-storage
              mountPath: /var/www/html
      volumes:
        - name: itop-web-persistent-storage
          persistentVolumeClaim:
            claimName: itop-web-pvc
