name: Ka0s JSON Compliance

on:
  workflow_dispatch:
    inputs:
      kaos-origin:
        description: 'Dispatcher Workflow Run ID'
        default: ""
        required: true
      kaos-files:
        description: 'Files Involved'
        default: ""
        required: true
      kaos-issue-id:
        description: 'Issue ID'
        default: "Kaos Issue ID"
        required: true
      kaos-user-start:
        description: 'User initiated process'
        default: ""
        required: true
  
permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

env:
  KAOS_MODULE: "[Ka0S] JSON COMPLIANCE"
  GH_TOKEN: ${{ secrets.KAOS_REPO_TOKEN }}
  KAOS_PRETTIER_CONFIG: "compliance/json/.prettierrc.json"
  KAOS_PATH_RESUME: "audit/jsonlint/"
  KAOS_REPO: "/actions-runner/_work/kaos/kaos"
  KAOS_STEP_MODULE: ""
  KAOS_CODE: ${{ github.run_id}}
  KAOS_REF_BRANCH: "main"

jobs:
  job-core:
    runs-on: swarm-runners-scaleset
    steps:
      - id: repo
        name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Suplimos falta de GH CLI en imagen
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli

      - id: install-node
        name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - id: install-tools
        name: Run Ka0s Lint JSON Action
        uses: ./.github/actions/kaos-lint-json
        with:
          file_path: ${{ github.event.inputs.kaos-files }}
          fix: 'true'
          path_resume: ${{ env.KAOS_PATH_RESUME }}jsonlint-results-${{ github.run_id }}.txt
      
      - name: Report Status
        if: failure()
        run: |
          FILE="${{ github.event.inputs.kaos-files }}"
          KAOS_ISSUE_BODY="The ${{ env.KAOS_MODULE }} process (${{ github.event.inputs.kaos-origin }}) failed. File ($FILE) has violations that could not be auto-fixed. Please check the logs."
          gh issue comment ${{ github.event.inputs.kaos-issue-id }} -b "$KAOS_ISSUE_BODY"
          exit 1
      
      - name: Report Success
        if: success()
        run: |
          FILE="${{ github.event.inputs.kaos-files }}"
          KAOS_ISSUE_BODY="The ${{ env.KAOS_MODULE }} process (${{ github.event.inputs.kaos-origin }}) successfully validated file ($FILE)."
          gh issue comment ${{ github.event.inputs.kaos-issue-id }} -b "$KAOS_ISSUE_BODY"
          
          # Check for changes (Self-Healing)
          git config --global user.name "${{ secrets.KAOS_BOT_NAME }}"
          git config --global user.email "${{ secrets.KAOS_BOT_EMAIL }}"
          if ! git diff --quiet; then
             git add "$FILE"
             git commit -m "[Ka0S] Self-Healing: Auto-formatting JSON compliance for $(basename "$FILE")"
             git push origin ${{ github.ref }} --force-with-lease
          fi

      - id: upload-logs
        name: Upload Logs
        if: always()
        run: |
             # Subir logs de auditoría si existen
             if [ -f "${{ env.KAOS_PATH_RESUME }}jsonlint-results-${{ github.run_id }}.txt" ]; then
                git config --global user.name "${{ secrets.KAOS_BOT_NAME }}"
                git config --global user.email "${{ secrets.KAOS_BOT_EMAIL }}"
                git pull --rebase
                git add ${{ env.KAOS_PATH_RESUME }}*
                if ! git diff --staged --quiet; then
                   git commit -m "[Ka0S] Uploading JSON compliance audit logs"
                   git push origin ${{ github.ref }} --force-with-lease
                fi
             fi

  handle-success:
     runs-on: swarm-runners-scaleset
     needs: [job-core]
     if: ${{ success() }}
     steps:
       - uses: actions/checkout@v4
       - uses: ./.github/actions/install-gh-cli
       - name: Notify Success
         env:
           GH_TOKEN: ${{ github.token }}
         run: |
           RNNUMBER=$(echo "${{ github.ref }}" | grep -o '[0-9]*')
           gh issue comment $RNNUMBER --body "✅ JSON Compliance finalizado correctamente ${{ env.KAOS_CODE }}."

  handle-failure:
    name: Handle Failure
    needs: [job-core, handle-success]
    if: failure()
    runs-on: swarm-runners-scaleset
    steps:
      - id: repo
        name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Create Incident Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "[INCIDENT]: Fallo en workflow ${{ github.workflow }}" \
            --label "itop-incident,triage,automated" \
            --body "### Organización
          Ka0s
          
          ### Solicitante
          @${{ github.actor }}
          
          ### Estado
          New
          
          ### Impacto
          Service
          
          ### Urgencia
          Medium
          
          ### Servicio / CI afectado
          GitHub Actions / ${{ github.workflow }}
          
          ### Descripción
          El workflow **${{ github.workflow }}** ha fallado durante su ejecución.
          
          **Detalles Técnicos:**
          - **Módulo**: ${{ env.KAOS_MODULE }}
          - **Run ID**: ${{ github.run_id }}
          - **Commit**: ${{ github.sha }}
          - **Branch/Ref**: ${{ github.ref_name }}
          - **Actor**: ${{ github.actor }}
          
          ### Pasos / Evidencias
          Logs de ejecución: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          "

  end-workflow:
    needs: [handle-success, handle-failure]
    if: always()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Trigger Inspector
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run inspector.yml \
            -f workflow_name="${{ github.workflow }}" \
            -f run_id="${{ github.run_id }}" \
            -f status="${{ job.status }}"
