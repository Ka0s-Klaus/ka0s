apiVersion: batch/v1
kind: Job
metadata:
  name: wazuh-security-init
  namespace: soc
spec:
  ttlSecondsAfterFinished: 600
  template:
    spec:
      containers:
        - name: security-init
          image: wazuh/wazuh-indexer:4.14.2
          env:
            - name: OPENSEARCH_JAVA_HOME
              value: /usr/share/wazuh-indexer/jdk
          command: ["/bin/bash", "-c"]
          args:
            - |
              echo "Waiting for Indexer to be ready..."
              until curl -s -k https://wazuh-indexer:9200; do sleep 5; done
              
              echo "Running securityadmin.sh..."
              # Fix: Definir variable si no existe, aunque ya la pasamos por env
              export OPENSEARCH_JAVA_HOME=/usr/share/wazuh-indexer/jdk
              
              /usr/share/wazuh-indexer/plugins/opensearch-security/tools/securityadmin.sh \
                -cd /usr/share/wazuh-indexer/plugins/opensearch-security/securityconfig/ \
                -icl -nhnv \
                -cacert /usr/share/wazuh-indexer/config/certs/root-ca.pem \
                -cert /usr/share/wazuh-indexer/config/certs/admin.pem \
                -key /usr/share/wazuh-indexer/config/certs/admin-key.pem \
                -h wazuh-indexer.soc.svc \
                -p 9300
          volumeMounts:
            - name: certificates
              mountPath: /usr/share/wazuh-indexer/config/certs
              readOnly: true
      volumes:
        - name: certificates
          secret:
            secretName: wazuh-indexer-certs
      restartPolicy: OnFailure
