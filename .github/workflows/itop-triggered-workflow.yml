name: Ka0s iTop Triggered Workflow

on:
  workflow_dispatch:
    inputs:
      itop_ticket_id:
        description: 'ID del ticket de iTop'
        required: true
        default: 'N/A'
      requester_name:
        description: 'Nombre del solicitante'
        required: true
        default: 'Ka0sC0re'

jobs:
  job-core:
    runs-on: swarm-runners-scaleset
    steps:
      - name: Print iTop Data
        run: |
          echo "Workflow iniciado desde iTop."
          echo "ID del Ticket: ${{ github.event.inputs.itop_ticket_id }}"
          echo "Solicitante: ${{ github.event.inputs.requester_name }}"

      - name: Checkout code
        uses: actions/checkout@v4

      # Aquí irían los pasos de tu automatización en ejecuciones futuras
      # Por ejemplo, ejecutar un script, desplegar una aplicación, etc.
      - name: Run automation script
        run: echo "Ejecutando la tarea automatizada..."

  update-itop-on-execute:
    runs-on: swarm-runners-scaleset
    needs: job-core
    if: success()
    steps:
      - name: Update iTop ticket on success
        if: steps.run-main-logic.outcome == 'success'
        run: |
          curl -k -X POST '${{ secrets.ITOP_URL }}/webservices/rest.php?version=1.3' \
          -H "Content-Type: application/x-www-form-urlencoded" \
          --data-urlencode 'auth_user=${{ secrets.ITOP_USER }}' \
          --data-urlencode 'auth_pwd=${{ secrets.ITOP_PASSWORD }}' \
          --data-urlencode 'json_data={ "operation": "core/update", "class": "UserRequest", "key": "SELECT UserRequest WHERE id = ${{ github.event.inputs.itop_ticket_id }}", "output_fields": "id", "fields": { "status": "closed", "solution": "El workflow de GitHub ha finalizado con éxito. El requerimiento se cierra automáticamente." } }'

      - name: Update iTop ticket on failure
        if: steps.run-main-logic.outcome != 'success'
        run: |
          curl -k -X POST '${{ secrets.ITOP_URL }}/webservices/rest.php?version=1.3' \
          -H "Content-Type: application/x-www-form-urlencoded" \
          --data-urlencode 'auth_user=${{ secrets.ITOP_USER }}' \
          --data-urlencode 'auth_pwd=${{ secrets.ITOP_PASSWORD }}' \
          --data-urlencode 'json_data={ "operation": "core/update", "class": "UserRequest", "key": "SELECT UserRequest WHERE id = ${{ github.event.inputs.itop_ticket_id }}", "output_fields": "id", "fields": { "solution": "El workflow de GitHub ha fallado. Por favor, revise los logs de la ejecución para más detalles." } }'

      - name: Update iTop on Success
        if: steps.execute-workflow.outputs.status == 'success'
        run: |
          curl -k -X POST '${{ secrets.ITOP_URL }}/webservices/rest.php?version=1.3' \
            -H 'Content-Type: application/json' \
            -d '{
              "operation": "core/update",
              "class": "UserRequest",
              "key": "${{ github.event.client_payload.itop_id }}",
              "output_fields": "ref",
              "auth_user": "${{ secrets.ITOP_API_USER }}",
              "auth_pwd": "${{ secrets.ITOP_API_PASSWORD }}",
              "fields": {
                "status": "resolved",
                "solution": "Solución provista por Asistencia. El workflow se ha ejecutado correctamente."
              }
            }'

      - name: Update iTop on Failure
        if: steps.execute-workflow.outputs.status == 'failure'
        run: |
          curl -k -X POST '${{ secrets.ITOP_URL }}/webservices/rest.php?version=1.3' \
            -H 'Content-Type: application/json' \
            -d '{
              "operation": "core/update",
              "class": "UserRequest",
              "key": "${{ github.event.client_payload.itop_id }}",
              "output_fields": "ref",
              "auth_user": "${{ secrets.ITOP_API_USER }}",
              "auth_pwd": "${{ secrets.ITOP_API_PASSWORD }}",
              "fields": {
                "solution": "Solución provista por Asistencia. El workflow ha fallado."
              }
            }'
