name: "[Ka0s] CMDB Full Sync -> iTop (Scheduled)"

on:
  schedule:
    # Runs at 02:00 UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Motivo de la ejecuci√≥n manual'
        required: false
        default: 'Sincronizaci√≥n manual bajo demanda'

permissions:
  contents: write # Needed for committing audit logs
  issues: write
  actions: read

env:
  KAOS_MODULE: "[Ka0s] CMDB Full Sync"
  KAOS_CORRELATION_ID: ${{ github.run_id }}
  KAOS_ACTOR: ${{ github.actor }}

jobs:
  full-sync:
    name: Full Cluster Sync
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/scripts
          fetch-depth: 0

      - name: Setup Environment
        run: |
          echo "Iniciando m√≥dulo: ${{ env.KAOS_MODULE }}"
          echo "Run ID: ${{ env.KAOS_CORRELATION_ID }}"
          echo "Actor: ${{ env.KAOS_ACTOR }}"

      - name: Setup Kubectl Tunnel
        uses: ./.github/actions/kubectl-tunnel
        with:
          host: ${{ secrets.KAOS_SSH_HOST_1 }}
          username: ${{ secrets.KAOS_SSH_USER }}
          key: ${{ secrets.KAOS_SSH_KEY_PRIV }}
          port: ${{ secrets.KAOS_SSH_PORT_1 }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests

      - name: Discover Services
        id: discover
        run: |
          echo "üîç Discovering Services in Cluster..."
          
          # Get all Namespaces that are NOT system namespaces
          NAMESPACES=$(kubectl get ns --no-headers -o custom-columns=":metadata.name" | grep -vE "^(kube-|cattle-|metallb-|ingress-|local-path)")
          
          echo "Found Namespaces: $NAMESPACES"
          
          SERVICES_LIST=""
          
          for NS in $NAMESPACES; do
             # Get services in this namespace
             SVCS=$(kubectl get svc -n "$NS" --no-headers -o custom-columns=":metadata.name" 2>/dev/null || true)
             if [ ! -z "$SVCS" ]; then
                # Append to list (replace newlines with comma)
                CLEAN_SVCS=$(echo "$SVCS" | tr '\n' ',' | sed 's/,$//')
                SERVICES_LIST="${SERVICES_LIST}${CLEAN_SVCS},"
             fi
          done
          
          # Remove trailing comma
          SERVICES_LIST=$(echo "$SERVICES_LIST" | sed 's/,$//')
          
          if [ -z "$SERVICES_LIST" ]; then
             echo "‚ö†Ô∏è No services found matching criteria."
             echo "services=" >> $GITHUB_OUTPUT
          else
             echo "‚úÖ Found Services: $SERVICES_LIST"
             echo "services=$SERVICES_LIST" >> $GITHUB_OUTPUT
          fi

      - name: Sync to iTop
        if: steps.discover.outputs.services != ''
        id: sync
        env:
          ITOP_URL: ${{ secrets.ITOP_URL }}
          ITOP_API_USER: ${{ secrets.ITOP_API_USER }}
          ITOP_API_PASSWORD: ${{ secrets.ITOP_API_PASSWORD }}
          ITOP_ORIGIN: ${{ secrets.ITOP_ORIGIN || vars.ITOP_ORIGIN || 'Demo' }}
        run: |
          python .github/scripts/itop-cmdb-sync.py \
            --services "${{ steps.discover.outputs.services }}" \
            --status "production"

      - name: Commit Audit Log
        if: steps.sync.outputs.audit_file != ''
        run: |
          git config --global user.name "${{ secrets.KAOS_BOT_NAME || 'Ka0s Bot' }}"
          git config --global user.email "${{ secrets.KAOS_BOT_EMAIL || 'bot@ka0s.io' }}"
          
          AUDIT_FILE="${{ steps.sync.outputs.audit_file }}"
          git add "$AUDIT_FILE"
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore(audit): add daily cmdb full sync log ${{ env.KAOS_CORRELATION_ID }} [skip ci]"
            
            # Reintento b√°sico de push para evitar conflictos de concurrencia
            count=0
            until git push origin HEAD:${{ github.ref_name }} || [ $count -eq 5 ]; do
              echo "Push fallido, reintentando..."
              git pull --rebase origin ${{ github.ref_name }}
              ((count++))
              sleep 2
            done
          fi

  handle-success:
    name: Handle Success
    needs: [full-sync]
    if: success()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Log Success
        run: echo "${{ env.KAOS_MODULE }} Success."

  handle-failure:
    name: Handle Failure
    needs: [full-sync, handle-success]
    if: failure()
    runs-on: swarm-runners-scaleset
    steps:
      - id: repo
        name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Create Incident Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "[INCIDENT]: Fallo en workflow ${{ github.workflow }}" \
            --label "itop-incident,triage,automated" \
            --body "### Organizaci√≥n
          Ka0s
          
          ### Solicitante
          @${{ github.actor }}
          
          ### Estado
          New
          
          ### Impacto
          Service
          
          ### Urgencia
          Medium
          
          ### Servicio / CI afectado
          GitHub Actions / ${{ github.workflow }}
          
          ### Descripci√≥n
          El workflow **${{ github.workflow }}** ha fallado durante su ejecuci√≥n.
          
          **Detalles T√©cnicos:**
          - **M√≥dulo**: ${{ env.KAOS_MODULE }}
          - **Run ID**: ${{ github.run_id }}
          - **Commit**: ${{ github.sha }}
          - **Branch/Ref**: ${{ github.ref_name }}
          - **Actor**: ${{ github.actor }}
          
          ### Pasos / Evidencias
          Logs de ejecuci√≥n: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          "

  end-workflow:
    needs: [handle-success, handle-failure]
    if: always()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Trigger Inspector
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run inspector.yml \
            -f workflow_name="${{ github.workflow }}" \
            -f run_id="${{ github.run_id }}" \
            -f status="${{ job.status }}"
