#!/bin/bash

# Script de remediación para CVE-2024-10041 (vulnerabilidad en PAM)
# Vulnerabilidad: Almacenamiento inseguro de información sensible en memoria

# Verificar ejecución como root
if [ "$(id -u)" -ne 0 ]; then
    echo "[!] Este script debe ejecutarse como root"
    exit 1
fi

echo "[+] Iniciando remediación para CVE-2024-10041"

# 1. Verificar estado de SELinux
selinux_status=$(getenforce)
if [ "$selinux_status" = "Enforcing" ]; then
    echo "  - SELinux está en modo Enforcing (mitigación activa)"
else
    echo "  [!] SELinux no está en modo Enforcing, configurando..."
    setenforce 1
    sed -i 's/^SELINUX=.*/SELINUX=enforcing/' /etc/selinux/config
fi

# 2. Actualizar paquetes PAM
echo "[+] Actualizando paquetes PAM"
if command -v apt-get &> /dev/null; then
    apt-get update && apt-get upgrade -y libpam-modules libpam-runtime
elif command -v yum &> /dev/null; then
    yum update -y pam
else
    echo "[!] No se encontró gestor de paquetes compatible (apt/yum)"
fi

# 3. Configurar parámetros de seguridad adicionales
echo "[+] Configurando parámetros de seguridad"

# Limitar acceso a /etc/shadow
echo "  - Restringiendo permisos de /etc/shadow"
chmod 000 /etc/shadow
chown root:root /etc/shadow

# Configurar límites de memoria para procesos PAM
echo "  - Configurando límites de memoria"
if [ -f "/etc/security/limits.conf" ]; then
    echo "* hard rss 512000" >> /etc/security/limits.conf
    echo "* hard as 1000000" >> /etc/security/limits.conf
fi

# 4. Recomendaciones adicionales
echo "\n[+] Recomendaciones de seguridad:"
echo "  - Implementar autenticación multifactor para servicios críticos"
echo "  - Monitorear intentos de acceso no autorizados"
echo "  - Considerar el uso de pam_exec para limpiar memoria después de autenticaciones"
echo "  - Revisar logs de autenticación regularmente (/var/log/secure, /var/log/auth.log)"

echo "\n[+] Remediation completada. Se recomienda reiniciar el sistema."