name: Fix SOC PVCs
on:
  workflow_dispatch:

jobs:
  fix-pvc:
    runs-on: swarm-runners-scaleset
    steps:
      - name: Setup Kubectl Tunnel
        uses: ./.github/actions/kubectl-tunnel
        with:
          host: ${{ secrets.KAOS_SSH_HOST_1 }}
          username: ${{ secrets.KAOS_SSH_USER }}
          key: ${{ secrets.KAOS_SSH_KEY_PRIV }}
          port: ${{ secrets.KAOS_SSH_PORT_1 }}

      - name: Fix Wazuh Indexer PV/PVC
        run: |
          echo "Deleting old PVC wazuh-indexer-pvc-v2 if it exists..."
          kubectl delete pvc wazuh-indexer-pvc-v2 -n soc --ignore-not-found=true
          
          echo "Patching PV wazuh-indexer-pv-v2 to remove claimRef..."
          kubectl patch pv wazuh-indexer-pv-v2 --type=json -p='[{"op": "remove", "path": "/spec/claimRef"}]' || echo "claimRef not found or already removed"
          
          echo "Verifying bindings..."
          kubectl get pvc -n soc
          kubectl get pv
