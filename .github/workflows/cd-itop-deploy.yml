name: CD iTop Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'core/b2b/core-services/itop/**'

permissions:
  contents: read

env:
  KAOS_MODULE: "CD-ITOP-DEPLOY"

jobs:
  deploy-itop:
    name: Deploy iTop to Cluster
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Kubectl Tunnel
        uses: ./.github/actions/kubectl-tunnel
        with:
          host: ${{ secrets.KAOS_SSH_HOST_1 }}
          username: ${{ secrets.KAOS_SSH_USER }}
          key: ${{ secrets.KAOS_SSH_KEY_PRIV }}
          port: ${{ secrets.KAOS_SSH_PORT_1 }}

      - name: Apply Kustomization
        run: |
          echo "Applying configuration for iTop..."
          kubectl apply -k core/b2b/core-services/itop/

      - name: Verify Rollout
        run: |
          echo "Waiting for rollout to complete..."
          kubectl rollout status deployment/itop -n itop --timeout=120s

  handle-success:
    runs-on: swarm-runners-scaleset
    needs: [deploy-itop]
    if: ${{ success() }}
    steps: 
      - id: handle-success-execution
        run: |
          echo "${{ env.KAOS_MODULE }} Success in runid ${{ github.run_id }}."
          
  handle-failure:
    runs-on: swarm-runners-scaleset
    needs: [deploy-itop]
    if: ${{ failure() }} 
    steps: 
      - id: check-execution
        run: |
          echo "Error detected in ${{ env.KAOS_MODULE }}."
