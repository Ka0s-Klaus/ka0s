#!/bin/bash

# Script de remediación para CVE-2016-20013
# Vulnerabilidad en sha256crypt/sha512crypt (DoS por consumo de CPU)

# Verificar si se ejecuta como root
if [ "$(id -u)" -ne 0 ]; then
    echo "Este script debe ejecutarse como root"
    exit 1
fi

# 1. Actualizar paquetes relacionados
echo "[+] Actualizando paquetes del sistema"
apt-get update && apt-get upgrade -y

# 2. Verificar versiones vulnerables
echo "[+] Verificando implementaciones vulnerables"
vulnerable=false

# Verificar glibc (implementación común)
if dpkg -l | grep -q "libc6"; then
    libc_version=$(dpkg -s libc6 | grep Version | awk '{print $2}')
    echo "  - libc6 versión: $libc_version"
    # Agregar lógica para comparar versiones si es necesario
fi

# 3. Configurar política de contraseñas para mitigación
echo "[+] Configurando política de contraseñas"

# Limitar longitud máxima de contraseñas en PAM
echo "Configurando límite de longitud de contraseña en PAM..."
if [ -f "/etc/security/pwquality.conf" ]; then
    sed -i 's/^# maxrepeat = .*/maxrepeat = 8/' /etc/security/pwquality.conf
    sed -i 's/^# maxsequence = .*/maxsequence = 3/' /etc/security/pwquality.conf
    echo "  - Configuración de pwquality actualizada"
fi

# 4. Recomendaciones adicionales
echo "[+] Recomendaciones:"
echo "  - Implementar contraseñas complejas pero no excesivamente largas"
echo "  - Considerar usar algoritmos alternativos como bcrypt o Argon2"
echo "  - Monitorear el uso de CPU durante operaciones de autenticación"

echo "\n[+] Remediation completada. Se recomienda reiniciar el sistema."