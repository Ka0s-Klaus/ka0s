#!/bin/bash

# Verificar ejecución como root
if [ "$(id -u)" -ne 0 ]; then
    echo "[!] Error: Este script debe ejecutarse como root"
    exit 1
fi

# 1. Verificar versión actual de PAM
echo "[+] Verificando versión de PAM..."
PAM_VERSION=$(dpkg -l | grep "pam" | awk '{print $3}')
echo "Versión actual de PAM: $PAM_VERSION"

# 2. Actualizar repositorios
echo "[+] Actualizando repositorios..."
apt-get update -qq

# 3. Buscar paquetes vulnerables
echo "[+] Buscando paquetes vulnerables..."
VULN_PKGS=$(apt list --installed | grep -E 'libpam-modules|libpam-runtime' 2>/dev/null)

if [ -z "$VULN_PKGS" ]; then
    echo "[+] No se encontraron paquetes vulnerables"
    exit 0
else
    echo "[!] Paquetes vulnerables encontrados:"
    echo "$VULN_PKGS"
fi

# 4. Actualizar paquetes PAM
echo "[+] Actualizando paquetes PAM..."
apt-get install --only-upgrade -y libpam-modules libpam-runtime

# 5. Configurar políticas de seguridad PAM
echo "[+] Configurando políticas de seguridad PAM..."

# Configurar /etc/pam.d/common-auth
if [ -f "/etc/pam.d/common-auth" ]; then
    echo "[+] Configurando /etc/pam.d/common-auth"
    sed -i 's/^auth\s*required\s*pam_unix.so.*/auth required pam_unix.so nullok_secure try_first_pass/' /etc/pam.d/common-auth
fi

# Configurar /etc/pam.d/common-password
if [ -f "/etc/pam.d/common-password" ]; then
    echo "[+] Configurando /etc/pam.d/common-password"
    sed -i 's/^password\s*\[.*\]\s*pam_unix.so.*/password [success=1 default=ignore] pam_unix.so obscure sha512/' /etc/pam.d/common-password
fi

# 6. Verificar remediación
echo "[+] Verificando remediación..."
UPDATED_PKGS=$(apt list --upgradable | grep -E 'libpam-modules|libpam-runtime' 2>/dev/null)

if [ -z "$UPDATED_PKGS" ]; then
    echo "[+] Remedación completada exitosamente"
    echo "[+] Recomendación: Reinicie el sistema para aplicar los cambios"
    exit 0
else
    echo "[!] Advertencia: Algunos paquetes aún necesitan actualización"
    echo "$UPDATED_PKGS"
    exit 1
fi