name: Ka0s Markdown Lint

on:
  workflow_dispatch:
    inputs:
      kaos-origin:
        description: 'Dispatcher Workflow Run ID'
        default: ""
        required: true
      kaos-files:
        description: 'Files Involved'
        default: ""
        required: true
      kaos-issue-id:
        description: 'Issue ID'
        default: "Kaos Issue ID"
        required: true
      kaos-user-start:
        description: 'User initiated process'
        default: ""
        required: true
  
permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

env:
  KAOS_MODULE: "[Ka0S] MDLINT"
  GH_TOKEN: ${{ secrets.KAOS_REPO_TOKEN }}
  KAOS_MD_CONFIG: "core/config/.markdownlint.json"
  KAOS_PRETTIER_CONFIG: "compliance/markdown/.prettierrc.json"
  KAOS_PATH_RESUME: "audit/mdlint/"
  KAOS_REPO: "/actions-runner/_work/kaos/kaos"
  KAOS_STEP_MODULE: ""
  KAOS_CODE: ${{ github.run_id}}
  KAOS_REF_BRANCH: "main"

jobs:
  job-core:
    runs-on: swarm-runners-scaleset
    steps:
      - id: repo
        name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Suplimos falta de GH CLI en imagen
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli

      - id: install-node
        name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - id: install-tools
        name: Install Compliance Tools
        run: |
            echo "Installing markdownlint-cli2 and prettier..."
            npm install -g markdownlint-cli2 prettier
            mkdir -p ${{ env.KAOS_PATH_RESUME }}

      - id: check-md
        name: Check and Self-Heal Markdown
        env:
           GH_TOKEN: ${{ github.token }}
        run: |
            # Archivo a comprobar
            FILE="${{ github.event.inputs.kaos-files }}"
            FILE_NAME=$(basename "$FILE")
            RESUME_FILE="${{ env.KAOS_PATH_RESUME }}mdlint-results-${{ github.run_id }}.txt"
            
            echo "Starting Compliance Check for: $FILE" > "$RESUME_FILE"
            
            # 1. Validaci√≥n de Sintaxis (MarkdownLint) - No recuperable autom√°ticamente
            if ! markdownlint-cli2 "$FILE" --config "${{ env.KAOS_MD_CONFIG }}" >> "$RESUME_FILE" 2>&1; then
              echo "‚ùå Syntax/Rule Error detected by MarkdownLint" >> "$RESUME_FILE"
              
              KAOS_ISSUE_BODY="The ${{ env.KAOS_MODULE }} process (${{ github.event.inputs.kaos-origin }}) failed. File ($FILE) has MARKDOWN VIOLATIONS that cannot be auto-fixed. Please fix manually."
              gh issue comment ${{ github.event.inputs.kaos-issue-id }} -b "$KAOS_ISSUE_BODY"
              exit 1
            else
              echo "‚úÖ Syntax/Rule Check Passed" >> "$RESUME_FILE"
            fi

            # 2. Validaci√≥n de Cumplimiento (Prettier) - Recuperable (Self-Healing)
            if ! prettier --check "$FILE" --config "${{ env.KAOS_PRETTIER_CONFIG }}"; then
              echo "‚ö†Ô∏è Compliance/Style Error detected. Attempting Self-Healing..." >> "$RESUME_FILE"
              
              # Self-Healing: Aplicar formato
              if prettier --write "$FILE" --config "${{ env.KAOS_PRETTIER_CONFIG }}"; then
                echo "‚úÖ Self-Healing Successful: File formatted to Ka0s Standards." >> "$RESUME_FILE"
                
                # Commit de la correcci√≥n
                git config --global user.name "${{ secrets.KAOS_BOT_NAME }}"
                git config --global user.email "${{ secrets.KAOS_BOT_EMAIL }}"
                git add "$FILE"
                if ! git diff --staged --quiet; then
                  git commit -m "[Ka0S] Self-Healing: Auto-formatting Markdown compliance for $FILE_NAME"
                  git push origin ${{ github.ref }} --force-with-lease
                  echo "üîÑ Changes pushed to repository." >> "$RESUME_FILE"
                fi
                
                KAOS_ISSUE_BODY="The ${{ env.KAOS_MODULE }} process (${{ github.event.inputs.kaos-origin }}) detected style violations in ($FILE) but successfully performed SELF-HEALING. No action required."
                gh issue comment ${{ github.event.inputs.kaos-issue-id }} -b "$KAOS_ISSUE_BODY"
              else
                echo "‚ùå Self-Healing Failed." >> "$RESUME_FILE"
                exit 1
              fi
            else
              echo "‚úÖ Compliance Check Passed (No changes needed)" >> "$RESUME_FILE"
              KAOS_ISSUE_BODY="The ${{ env.KAOS_MODULE }} process (${{ github.event.inputs.kaos-origin }}) successfully validated file ($FILE). All checks passed."
              gh issue comment ${{ github.event.inputs.kaos-issue-id }} -b "$KAOS_ISSUE_BODY"
            fi
            
            cat "$RESUME_FILE"

      - id: upload-logs
        name: Upload Logs
        if: always()
        run: |
             # Subir logs de auditor√≠a si existen
             if [ -f "${{ env.KAOS_PATH_RESUME }}mdlint-results-${{ github.run_id }}.txt" ]; then
                git config --global user.name "${{ secrets.KAOS_BOT_NAME }}"
                git config --global user.email "${{ secrets.KAOS_BOT_EMAIL }}"
                git pull --rebase
                git add ${{ env.KAOS_PATH_RESUME }}*
                if ! git diff --staged --quiet; then
                   git commit -m "[Ka0S] Uploading Markdown compliance audit logs"
                   git push origin ${{ github.ref }} --force-with-lease
                fi
             fi

  handle-success:
     runs-on: swarm-runners-scaleset
     needs: [job-core]
     if: ${{ success() }}
     steps:
       - uses: actions/checkout@v4
       - uses: ./.github/actions/install-gh-cli
       - name: Notify Success
         env:
           GH_TOKEN: ${{ github.token }}
         run: |
           RNNUMBER=$(echo "${{ github.ref }}" | grep -o '[0-9]*')
           gh issue comment $RNNUMBER --body "‚úÖ Markdown Compliance finalizado correctamente ${{ env.KAOS_CODE }}."

  handle_failure:
    runs-on: swarm-runners-scaleset
    needs: [job-core, handle-success]
    if: ${{ failure() }} 
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/install-gh-cli
      - name: Notify Failure
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue create --title "${{ env.KAOS_MODULE }} Error in ${{ env.KAOS_CODE }}" --label "bug" --body "Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          RNNUMBER=$(echo "${{ github.ref }}" | grep -o '[0-9]*')
          gh issue comment $RNNUMBER --body "‚ùå El proceso de Compliance Markdown ha fallado ${{ env.KAOS_CODE }}."

  end-workflow:
    runs-on: swarm-runners-scaleset
    needs: [job-core, handle-success, handle_failure]
    if: ${{ always() }} 
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/install-gh-cli
      - name: End Workflow
        env:
            GH_TOKEN: ${{ github.token }}
        run: |
          RNNUMBER=$(echo "${{ github.ref }}" | grep -o '[0-9]*')
          gh workflow run inspector.yml --ref 'main' -f kaos-issue-id=$RNNUMBER -f kaos-workflow-id="${{ env.KAOS_CODE }}" -f kaos-user-start=""
