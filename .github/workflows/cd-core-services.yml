name: "Ka0s CD Core Services Deploy -> K8s"
on:
  push:
    branches:
      - main
    paths:
      - 'core/b2b/core-services/**'
      - '!core/b2b/core-services/kube/**'

permissions:
  contents: write
  issues: write
  actions: write

env:
  KAOS_MODULE: "[Ka0s] CD Core Services"
  KAOS_CODE: ${{ github.run_id }}

jobs:
  deploy-services:
    name: Deploy Changed Services
    runs-on: swarm-runners-scaleset
    outputs:
      services: ${{ steps.deploy_step.outputs.services }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Kubectl Tunnel
        uses: ./.github/actions/kubectl-tunnel
        with:
          host: ${{ secrets.KAOS_SSH_HOST_1 }}
          username: ${{ secrets.KAOS_SSH_USER }}
          key: ${{ secrets.KAOS_SSH_KEY_PRIV }}
          port: ${{ secrets.KAOS_SSH_PORT_1 }}

      - name: Detect and Deploy
        id: deploy_step
        run: |
          echo "Detecting changes..."
          
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          
          # Fallback for cases where before SHA is zero (e.g. new branch push, though rare on main)
          if [ -z "$BEFORE" ] || [ "$BEFORE" == "0000000000000000000000000000000000000000" ]; then
            BEFORE="HEAD~1"
          fi
          
          echo "Diffing range: $BEFORE...$AFTER"
          
          # 1. Get changed files
          # 2. Filter for core/b2b/core-services/
          # 3. Exclude core/b2b/core-services/kube/
          # 4. Extract the service root path (core/b2b/core-services/<service-name>)
          # 5. Sort and Uniq
          
          CHANGED_SERVICES=$(git diff --name-only "$BEFORE" "$AFTER" | \
            grep "^core/b2b/core-services/" | \
            grep -v "^core/b2b/core-services/kube/" | \
            cut -d/ -f1-4 | \
            sort | uniq)
          
          # Convert to comma-separated for output
          SERVICES_CSV=$(echo "$CHANGED_SERVICES" | tr '\n' ',' | sed 's/,$//')
          echo "services=$SERVICES_CSV" >> $GITHUB_OUTPUT
          
          if [ -z "$CHANGED_SERVICES" ]; then
            echo "No relevant services changed in this push."
            exit 0
          fi
          
          echo "Found modified services: $CHANGED_SERVICES"
          
          for SERVICE in $CHANGED_SERVICES; do
            # Check if directory still exists (it might have been deleted)
            if [ ! -d "$SERVICE" ]; then
               echo "‚ö†Ô∏è  Service directory $SERVICE was deleted. Skipping."
               continue
            fi

            # Check for kustomization.yaml
            if [ -f "$SERVICE/kustomization.yaml" ]; then
              echo "---------------------------------------------------"
              echo "üöÄ Deploying Service: $SERVICE"
              echo "---------------------------------------------------"
              
              # Detect Namespace Logic
              SERVICE_NAME=$(basename $SERVICE)
              NAMESPACE=$SERVICE_NAME # Default fallback

              # 1. Check kustomization.yaml for global namespace override
              KUST_NS=$(grep "^namespace:" "$SERVICE/kustomization.yaml" | awk '{print $2}')
              if [ ! -z "$KUST_NS" ]; then
                NAMESPACE=$KUST_NS
              else
                # 2. Look for explicit Namespace resource files
                # Find files that contain "kind: Namespace" within the service directory
                NS_FILE=$(grep -l "kind: Namespace" "$SERVICE/"*.yaml | head -n 1)
                if [ ! -z "$NS_FILE" ]; then
                  # Extract name from metadata.name
                  DETECTED_NS=$(grep -A 5 "metadata:" "$NS_FILE" | grep "name:" | awk '{print $2}' | head -n 1)
                  if [ ! -z "$DETECTED_NS" ]; then
                     NAMESPACE=$DETECTED_NS
                  fi
                fi
              fi
              echo "üéØ Target Namespace: $NAMESPACE"

              kubectl apply -k "$SERVICE/"
              
              echo "‚è≥ Waiting for rollout..."
              # Intentar esperar rollout de deployments si existen en el kustomization
              kubectl rollout status deployment -n "$NAMESPACE" --timeout=60s || echo "‚ö†Ô∏è Rollout wait warning (maybe no deployment or timeout)"

              echo "üìä Generating Post-Deploy Report for $SERVICE..."
              REPORT_FILE="deployment-report-$SERVICE_NAME-${{ github.run_id }}.txt"
              
              echo "Deployment Report: $SERVICE" > $REPORT_FILE
              echo "Date: $(date)" >> $REPORT_FILE
              echo "Trigger: ${{ github.event_name }} by ${{ github.actor }}" >> $REPORT_FILE
              echo "Namespace: $NAMESPACE" >> $REPORT_FILE
              echo "---------------------------------------------------" >> $REPORT_FILE
              echo ">>> Pods Status:" >> $REPORT_FILE
              kubectl get pods -n "$NAMESPACE" -o wide >> $REPORT_FILE 2>&1 || echo "No pods found or namespace error" >> $REPORT_FILE
              echo "" >> $REPORT_FILE
              echo ">>> Services Status:" >> $REPORT_FILE
              kubectl get svc -n "$NAMESPACE" >> $REPORT_FILE 2>&1 || echo "No services found" >> $REPORT_FILE
              echo "" >> $REPORT_FILE
              echo ">>> Ingress Status:" >> $REPORT_FILE
              kubectl get ingress -n "$NAMESPACE" >> $REPORT_FILE 2>&1 || echo "No ingress found" >> $REPORT_FILE
              
              echo "---------------------------------------------------"
              cat $REPORT_FILE
              echo "---------------------------------------------------"

              echo "üîç Running Advanced Verification..."
              
              # Auto-detect expected IP for LoadBalancer services
              EXPECTED_IP=""
              SERVICE_TYPE=$(kubectl get svc -n "$NAMESPACE" "$SERVICE_NAME" -o jsonpath='{.spec.type}' 2>/dev/null || echo "Unknown")
              
              if [ "$SERVICE_TYPE" == "LoadBalancer" ]; then
                echo "‚ÑπÔ∏è Service $SERVICE_NAME is LoadBalancer. Detecting assigned IP..."
                # Wait briefly for IP assignment if needed (though rollout status above should have covered pod readiness)
                EXPECTED_IP=$(kubectl get svc -n "$NAMESPACE" "$SERVICE_NAME" -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                
                if [ -z "$EXPECTED_IP" ]; then
                   echo "‚ö†Ô∏è LoadBalancer IP not yet assigned. Verification might fail on IP check."
                else
                   echo "üéØ Detected LoadBalancer IP: $EXPECTED_IP"
                fi
              fi
              
              # Ensure script is executable
              chmod +x .github/scripts/k8s-verify-deployment.sh
              
              # Run verification and append to report
              echo "---------------------------------------------------" >> $REPORT_FILE
              echo ">>> Advanced Verification Results:" >> $REPORT_FILE
              
              JSON_REPORT_FILE="deployment-report-$SERVICE_NAME-${{ github.run_id }}.json"
              ./.github/scripts/k8s-verify-deployment.sh "$NAMESPACE" "$SERVICE_NAME" "$EXPECTED_IP" "$JSON_REPORT_FILE" 2>&1 | tee -a $REPORT_FILE
              
              # Save reports to audit/deploy
              mkdir -p audit/deploy
              FINAL_REPORT_PATH="audit/deploy/deployment-report-$SERVICE_NAME-${{ github.run_id }}.md"
              FINAL_JSON_PATH="audit/deploy/deployment-report-$SERVICE_NAME-${{ github.run_id }}.json"
              
              mv $REPORT_FILE $FINAL_REPORT_PATH
              [ -f "$JSON_REPORT_FILE" ] && mv "$JSON_REPORT_FILE" "$FINAL_JSON_PATH"
              
              echo "REPORT_PATH=$FINAL_REPORT_PATH" >> $GITHUB_ENV
              echo "LAST_SERVICE=$SERVICE_NAME" >> $GITHUB_ENV
              echo "LAST_NAMESPACE=$NAMESPACE" >> $GITHUB_ENV
              
            else
              echo "‚ö†Ô∏è  Skipping $SERVICE: No kustomization.yaml found."
            fi
          done

      - name: Commit Deployment Reports
        if: always()
        run: |
          git config --global user.name "Ka0s CI Bot"
          git config --global user.email "ci@ka0s.io"
          git pull --rebase
          git add audit/deploy/
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore(cd): save deployment audit reports [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
          fi


  sync-cmdb:
    needs: [deploy-services]
    if: ${{ success() && needs.deploy-services.outputs.services != '' }}
    uses: ./.github/workflows/itop-cmdb-sync.yml
    with:
      services: ${{ needs.deploy-services.outputs.services }}
      status: "production"
    secrets:
      ITOP_URL: ${{ secrets.ITOP_URL }}
      ITOP_API_USER: ${{ secrets.ITOP_API_USER }}
      ITOP_API_PASSWORD: ${{ secrets.ITOP_API_PASSWORD }}
      ITOP_ORIGIN: ${{ secrets.ITOP_ORIGIN || vars.ITOP_ORIGIN }}

  handle-success:
    runs-on: swarm-runners-scaleset
    needs: [deploy-services, sync-cmdb]
    if: ${{ success() }}
    steps: 
      - run: echo "CD-CORE-SERVICES & CMDB Sync Success in runid ${{ github.run_id }}."
          
  handle-failure:
    runs-on: swarm-runners-scaleset
    needs: [deploy-services, sync-cmdb]
    if: ${{ failure() }} 
    steps: 
      - run: echo "Error detected in CD-CORE-SERVICES or CMDB Sync."
