name: iTop Daily Audit Export

on:
  schedule:
    # Ejecutar a las 01:00 UTC todos los días
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      date:
        description: 'Fecha a exportar (YYYY-MM-DD). Dejar vacío para "ayer".'
        required: false
        default: ''

permissions:
  contents: write
  issues: write
  actions: write

env:
  KAOS_MODULE: "[Ka0S] iTop Daily Audit Export"

jobs:
  audit-export:
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Export iTop Data
        uses: ./.github/actions/itop-export
        with:
          itop-url: ${{ secrets.ITOP_URL || vars.ITOP_URL }}
          itop-user: ${{ secrets.ITOP_API_USER }}
          itop-password: ${{ secrets.ITOP_API_PASSWORD }}
          date: ${{ github.event.inputs.date }}
          output-dir: 'audit/itop'

      - name: Commit and Push changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          git add audit/itop/*.json
          
          # Verificar si hay cambios antes de hacer commit
          if git diff --staged --quiet; then
            echo "No hay nuevos ficheros de auditoría para guardar."
          else
            git commit -m "Audit: iTop export $(date +%Y-%m-%d)"
            git push
          fi

  handle-success:
    name: Handle Success
    needs: [audit-export]
    if: success()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Log Success
        run: echo "${{ env.KAOS_MODULE }} Success."

  handle-failure:
    name: Handle Failure
    needs: [audit-export, handle-success]
    if: failure()
    runs-on: swarm-runners-scaleset
    steps:
      - id: repo
        name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Create Incident Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "[INCIDENT]: Fallo en workflow ${{ github.workflow }}" \
            --label "itop-incident,triage,automated" \
            --body "### Organización
          Ka0s
          
          ### Solicitante
          @${{ github.actor }}
          
          ### Estado
          New
          
          ### Impacto
          Service
          
          ### Urgencia
          Medium
          
          ### Servicio / CI afectado
          GitHub Actions / ${{ github.workflow }}
          
          ### Descripción
          El workflow **${{ github.workflow }}** ha fallado durante su ejecución.
          
          **Detalles Técnicos:**
          - **Módulo**: ${{ env.KAOS_MODULE }}
          - **Run ID**: ${{ github.run_id }}
          - **Commit**: ${{ github.sha }}
          - **Branch/Ref**: ${{ github.ref_name }}
          - **Actor**: ${{ github.actor }}
          
          ### Pasos / Evidencias
          Logs de ejecución: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          "

  end-workflow:
    needs: [handle-success, handle-failure]
    if: always()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Trigger Inspector
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run inspector.yml \
            -f workflow_name="${{ github.workflow }}" \
            -f run_id="${{ github.run_id }}" \
            -f status="${{ job.status }}"
