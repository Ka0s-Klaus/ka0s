name: iTop Create API User

on:
  workflow_dispatch:
    inputs:
      runner:
        description: "Runner a usar (si GitHub-hosted no llega a iTop, usa self-hosted)"
        required: false
        default: "self-hosted"
        type: choice
        options:
          - self-hosted
          - github-hosted
      target_login:
        description: "Login del usuario a crear"
        required: false
        default: "itop_api_integration"
      target_first_name:
        description: "Nombre"
        required: false
        default: "API"
      target_last_name:
        description: "Apellido"
        required: false
        default: "Integration"
      target_email:
        description: "Email (opcional, recomendado para reconciliación)"
        required: false
        default: ""
      target_org_name:
        description: "Organización existente en iTop (Organization.name)"
        required: true
      target_profiles:
        description: "Perfiles separados por coma (incluye REST Services User)"
        required: false
        default: "REST Services User"
      target_language:
        description: "Idioma (ej: EN US)"
        required: false
        default: "EN US"
      update_password:
        description: "Actualizar password si el usuario ya existe (true/false)"
        required: false
        default: "false"

jobs:
  create-api-user:
    runs-on: ${{ github.event.inputs.runner == 'github-hosted' && 'ubuntu-latest' || 'swarm-runners-scaleset' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check connectivity to iTop
        env:
          ITOP_URL: ${{ secrets.ITOP_URL || vars.ITOP_URL }}
          ITOP_TLS_VERIFY: ${{ vars.ITOP_TLS_VERIFY || 'false' }}
        run: |
          set -euo pipefail
          BASE="${ITOP_URL%/}"
          URL="https://itsm.ka0s.io/webservices/rest.php?version=1.3"
          echo "Checking: ${URL}"
          echo "Proxy vars present (names only):"
          env | grep -i proxy | cut -d= -f1 || true
          unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY all_proxy ALL_PROXY no_proxy NO_PROXY
          CURL_TLS_FLAGS=""
          if [ "${ITOP_TLS_VERIFY}" = "false" ] || [ "${ITOP_TLS_VERIFY}" = "0" ]; then
            CURL_TLS_FLAGS="-k"
          fi
          curl --noproxy '*' ${CURL_TLS_FLAGS} -fsS --retry 5 --retry-all-errors --connect-timeout 10 --max-time 30 -o /dev/null -I "${URL}"

      - name: Create iTop API user
        env:
          ITOP_URL: ${{ secrets.ITOP_URL || vars.ITOP_URL }}
          ITOP_USER: ${{ secrets.ITOP_API_USER }}
          ITOP_PASSWORD: ${{ secrets.ITOP_API_PASSWORD }}
          ITOP_TLS_VERIFY: ${{ vars.ITOP_TLS_VERIFY || 'false' }}

          ITOP_TARGET_LOGIN: ${{ github.event.inputs.target_login }}
          ITOP_TARGET_PASSWORD: ${{ secrets.ITOP_TARGET_PASSWORD }}
          ITOP_TARGET_FIRST_NAME: ${{ github.event.inputs.target_first_name }}
          ITOP_TARGET_LAST_NAME: ${{ github.event.inputs.target_last_name }}
          ITOP_TARGET_EMAIL: ${{ github.event.inputs.target_email }}
          ITOP_TARGET_ORG_NAME: ${{ github.event.inputs.target_org_name }}
          ITOP_TARGET_PROFILES: ${{ github.event.inputs.target_profiles }}
          ITOP_TARGET_LANGUAGE: ${{ github.event.inputs.target_language }}
          ITOP_UPDATE_PASSWORD: ${{ github.event.inputs.update_password }}
        run: |
          unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY all_proxy ALL_PROXY no_proxy NO_PROXY
          python3 devops/core/itop/create-itop-api-user.py
