#!/bin/bash

# Vulnerabilidad: CVE-2021-3773 - Buffer overflow en pam_ldap

# Verificar ejecución como root
if [ "$(id -u)" -ne 0 ]; then
    echo "[!] Este script debe ejecutarse como root"
    exit 1
fi

echo "[+] Iniciando remediación para CVE-2021-3773"

# 1. Verificar paquete pam_ldap instalado
if dpkg -l | grep -q "pam-ldap" || rpm -qa | grep -q "pam_ldap"; then
    echo "  - Paquete pam_ldap encontrado"
    
    # 2. Actualizar paquete pam_ldap
    if command -v apt-get &> /dev/null; then
        echo "[+] Actualizando pam_ldap con apt"
        apt-get update && apt-get upgrade -y libpam-ldap
    elif command -v yum &> /dev/null; then
        echo "[+] Actualizando pam_ldap con yum"
        yum update -y pam_ldap
    else
        echo "[!] No se encontró gestor de paquetes compatible (apt/yum)"
    fi
    
    # 3. Verificar versión actualizada
    echo "[+] Verificando versión actualizada"
    if dpkg -l | grep -q "pam-ldap" || rpm -qa | grep -q "pam_ldap"; then
        echo "  - Paquete pam_ldap actualizado correctamente"
    else
        echo "  [!] No se pudo actualizar pam_ldap, considere desinstalarlo"
    fi
else
    echo "  - Paquete pam_ldap no encontrado (no es vulnerable)"
fi

# 4. Recomendaciones adicionales
echo "\n[+] Recomendaciones de seguridad:"
echo "  - Si no necesita autenticación LDAP, considere desinstalar pam_ldap"
echo "  - Implementar autenticación multifactor para servicios críticos"
echo "  - Monitorear intentos de acceso no autorizados"
echo "  - Revisar logs de autenticación regularmente (/var/log/secure, /var/log/auth.log)"

echo "\n[+] Remediation completada. Se recomienda reiniciar los servicios afectados."