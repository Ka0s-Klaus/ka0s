name: Ka0s Scan Directories and Trigger Workflows

on:
  workflow_dispatch:
    inputs:
      base_path:
        description: 'Base path to scan for Docker projects (e.g., core/runner)'
        required: false
        default: 'core/runner'
        type: string
      target_workflow:
        description: 'Target workflow to trigger for each Docker image'
        required: false
        default: 'scan-image.yml'
        type: string
      dry_run:
        description: 'Only generate report without triggering workflows'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: write

env:
  KAOS_BASE_PATH: core/runner
  KAOS_MODULE: "[Ka0S] Scan Directories and Trigger Workflows"
  KAOS_CODE: ${{ github.run_id }}
  KAOS_TARGET_WORKFLOW: scan-image.yml
  KAOS_DRY_RUN: false
  REPORTS_DESTINATION: audit/scan

jobs:
  job-core:
    runs-on: swarm-runners-scaleset
    outputs:
      matrix: ${{ steps.create-matrix.outputs.matrix }}
      has-dockerfiles: ${{ steps.create-matrix.outputs.has-dockerfiles }}
    
    steps:
    - name: Checkout code
      if: ${{ always() }}
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.KAOS_REPO_TOKEN }}

    - name: Scan directories and create matrix
      id: create-matrix
      run: |
        BASE_PATH="${{ github.event.inputs.base_path }}"
        REPORT_FILE="$REPORTS_DESTINATION/$KAOS_CODE-$(date +%Y%m%d-%H%M%S).md"
        
        # Validate base path exists
        if [ ! -d "$BASE_PATH" ]; then
          echo "âŒ Error: Base path '$BASE_PATH' does not exist"
          exit 1
        fi
        
        # Extract main folder name
        MAIN_FOLDER=$(basename "$BASE_PATH")
        echo "ðŸ“ Main folder: $MAIN_FOLDER"
        
        # Initialize report
        cat > "$REPORT_FILE" << EOF
        # Directory Scan Report
        
        **Generated:** $(date '+%Y-%m-%d %H:%M:%S UTC')
        **Base Path:** \`$BASE_PATH\`
        **Main Folder:** \`$MAIN_FOLDER\`
        
        ## Summary
        EOF
        
        # Initialize counters and matrix
        TOTAL_SUBDIRS=0
        TOTAL_FILES=0
        TOTAL_DOCKERFILES=0
        MATRIX_ITEMS="[]"
        
        # Scan first-level subdirectories
        echo "" >> "$REPORT_FILE"
        echo "## Subdirectories Analysis" >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
        
        for subdir in "$BASE_PATH"/*/; do
          if [ -d "$subdir" ]; then
            SUBDIR_NAME=$(basename "$subdir")
            TOTAL_SUBDIRS=$((TOTAL_SUBDIRS + 1))
            
            echo "### ðŸ“‚ $SUBDIR_NAME" >> "$REPORT_FILE"
            echo "**Path:** \`$subdir\`" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            
            # Count files and subdirectories
            FILE_COUNT=$(find "$subdir" -maxdepth 1 -type f | wc -l)
            SUBDIR_COUNT=$(find "$subdir" -maxdepth 1 -type d | wc -l)
            SUBDIR_COUNT=$((SUBDIR_COUNT - 1))  # Exclude the directory itself
            
            TOTAL_FILES=$((TOTAL_FILES + FILE_COUNT))
            
            echo "- **Files:** $FILE_COUNT" >> "$REPORT_FILE"
            echo "- **Subdirectories:** $SUBDIR_COUNT" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            
            # List contents
            echo "**Contents:**" >> "$REPORT_FILE"
            for item in "$subdir"*; do
              if [ -e "$item" ]; then
                ITEM_NAME=$(basename "$item")
                if [ -d "$item" ]; then
                  echo "- ðŸ“ $ITEM_NAME/" >> "$REPORT_FILE"
                else
                  echo "- ðŸ“„ $ITEM_NAME" >> "$REPORT_FILE"
                fi
              fi
            done
            echo "" >> "$REPORT_FILE"
            
            # Check for Dockerfiles in subdirectories (versions)
            DOCKERFILES_FOUND=0
            echo "**Docker Analysis:**" >> "$REPORT_FILE"
            
            for version_dir in "$subdir"/*/; do
              if [ -d "$version_dir" ]; then
                VERSION_NAME=$(basename "$version_dir")
                DOCKERFILE_PATH="$version_dir/Dockerfile"
                
                if [ -f "$DOCKERFILE_PATH" ]; then
                  DOCKERFILES_FOUND=$((DOCKERFILES_FOUND + 1))
                  TOTAL_DOCKERFILES=$((TOTAL_DOCKERFILES + 1))
                  
                  echo "- âœ… Version \`$VERSION_NAME\`: Dockerfile found" >> "$REPORT_FILE"
                  
                  # Add to matrix for workflow triggering
                  MATRIX_ITEM=$(cat << EOF
        {
          "image_name": "$SUBDIR_NAME",
          "version": "$VERSION_NAME",
          "dockerfile_path": "$DOCKERFILE_PATH"
        }
        EOF
                  )
                  
                  if [ "$MATRIX_ITEMS" = "[]" ]; then
                    MATRIX_ITEMS="[$MATRIX_ITEM]"
                  else
                    MATRIX_ITEMS=$(echo "$MATRIX_ITEMS" | jq ". + [$MATRIX_ITEM]")
                  fi
                else
                  echo "- âŒ Version \`$VERSION_NAME\`: No Dockerfile" >> "$REPORT_FILE"
                fi
              fi
            done
            
            if [ $DOCKERFILES_FOUND -eq 0 ]; then
              echo "- âš ï¸  No Dockerfiles found in any version subdirectory" >> "$REPORT_FILE"
            fi
            
            echo "" >> "$REPORT_FILE"
          fi
        done
        
        # Update summary
        MATRIX_COUNT=$(echo "$MATRIX_ITEMS" | jq length 2>/dev/null || echo 0)
        SUMMARY_CONTENT="- **Total Subdirectories:** $TOTAL_SUBDIRS\n- **Total Files:** $TOTAL_FILES\n- **Total Dockerfiles:** $TOTAL_DOCKERFILES\n- **Docker Images to Process:** $MATRIX_COUNT"
        awk -v content="$SUMMARY_CONTENT" '/## Summary/{print; print content; next}1' "$REPORT_FILE" > "${REPORT_FILE}.tmp" && mv "${REPORT_FILE}.tmp" "$REPORT_FILE"
        
        # Add build matrix section
        echo "## Build Matrix" >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
        if [ "$MATRIX_ITEMS" != "[]" ]; then
          echo "The following Docker images will be processed:" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "\`\`\`json" >> "$REPORT_FILE"
          echo "$MATRIX_ITEMS" | jq . >> "$REPORT_FILE" 2>/dev/null || echo "$MATRIX_ITEMS" >> "$REPORT_FILE"
          echo "\`\`\`" >> "$REPORT_FILE"
        else
          echo "âŒ No Docker images found to process." >> "$REPORT_FILE"
        fi
        
        # Set outputs
        MATRIX_ITEMS=$(echo "$MATRIX_ITEMS" | jq -c .)
        echo "matrix=$MATRIX_ITEMS" >> $GITHUB_OUTPUT
        echo "has-dockerfiles=$([ "$MATRIX_ITEMS" != "[]" ] && echo true || echo false)" >> $GITHUB_OUTPUT
        echo "report-file=$REPORT_FILE" >> $GITHUB_OUTPUT
        
        # Display summary
        echo "ðŸ“Š Scan completed:"
        echo "   - Subdirectories: $TOTAL_SUBDIRS"
        echo "   - Files: $TOTAL_FILES"
        echo "   - Dockerfiles: $TOTAL_DOCKERFILES"
        echo "   - Report: $REPORT_FILE"

    - name: Commit scan report
      run: |
        REPORT_FILE="${{ steps.create-matrix.outputs.report-file }}"
        git config --global user.name "${{ secrets.KAOS_BOT_NAME }}"
        git config --global user.email "${{ secrets.KAOS_BOT_EMAIL }}"
        git add "$REPORT_FILE"
        git commit -m "[Ka0s] ðŸ“Š Directory scan report: ${{ github.event.inputs.base_path }}" || echo "No changes to commit"
        git push
  job-trigger-workflows:
    needs: job-core
    if: ${{ needs.job-core.outputs.has-dockerfiles == 'true' && github.event.inputs.dry_run == 'false' }}
    runs-on: swarm-runners-scaleset
    strategy:
      matrix:
        include: ${{ fromJson(needs.job-core.outputs.matrix) }}
      fail-fast: false
    steps:
    - name: Trigger scan-image workflow
      run: |
        curl -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/scan-image.yml/dispatches \
          -d '{
            "ref": "main",
            "inputs": {
              "image_name": "${{ matrix.image_name }}",
              "dockerfile_path": "${{ matrix.dockerfile_path }}",
              "version": "${{ matrix.version }}"
            }
          }'
        echo "Esperando 60 segundos antes de lanzar el siguiente workflow..."
        sleep 60

  handle-success:
    runs-on: swarm-runners-scaleset
    needs: [job-core, job-trigger-workflows]
    if: ${{ success() }}
    steps:
      - id: repo
        name: Checkout code
        if: ${{ always() }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.KAOS_REPO_TOKEN }}
      - id: handle-success-execution
        name: handle-success-execution
        env:
          GH_TOKEN: ${{ secrets.KAOS_REPO_TOKEN }}
        run: |
          # Si todo ha ido correcto aÃ±adimos el contenido del fichero 
          RNNUMBER=$(echo "${{ github.ref }}" | grep -o '[0-9]*')
          gh issue comment $RNNUMBER --body "El proceso ha finalizado correctamente ${{ env.KAOS_CODE }}. El resultado de la ejecuciÃ³n se guardarÃ¡ en MongoDB"
  handle_failure:
    runs-on: swarm-runners-scaleset
    needs: [job-core, job-trigger-workflows, handle-success]
    if: ${{ failure() }} 
    steps:
      - id: repo
        name: Checkout code
        if: ${{ always() }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.KAOS_REPO_TOKEN }}
      - id: handle-failure-execution
        name: handle-failure-execution
        env:
          GH_TOKEN: ${{ secrets.KAOS_REPO_TOKEN }}
        run: |
          echo "Error detected in process"
          echo "Created issue"
          gh issue create  --title "${{ env.KAOS_MODULE }} Error detected in ${{ env.KAOS_CODE }}" --label "bug" --body "Please check the logs 'https://github.com/Ka0s-Klaus/ka0s/actions/runs/${{ env.KAOS_CODE }}' for more information of error."
  end-workflow:
    runs-on: swarm-runners-scaleset
    needs: [job-core, job-trigger-workflows, handle-success, handle_failure]
    if: ${{ always() && !contains(github.event.head_commit.message, '[Ka0S] ') }} 
    env:
        GH_TOKEN: ${{ secrets.KAOS_ACTIONS_TOKEN }}
    steps:
      - id: repo
        name: Checkout code
        if: ${{ always() }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.KAOS_REPO_TOKEN }}
      - id: end-process
        name: Finaliza el workflow
        run: |
          echo "End process"
          RNNUMBER=$(echo "${{ github.ref }}" | grep -o '[0-9]*')
          gh issue comment $RNNUMBER --body "Se finaliza Ka0s ${{ env.KAOS_CODE }}"
          gh workflow run inspector.yml --ref 'main' -f kaos-issue-id=$RNNUMBER -f kaos-workflow-id="${{ env.KAOS_CODE }}" -f kaos-user-start=""
