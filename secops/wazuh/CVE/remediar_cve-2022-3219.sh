#!/bin/bash

# Verificar ejecución como root
if [ "$(id -u)" -ne 0 ]; then
    echo "[!] Error: Este script debe ejecutarse como root"
    exit 1
fi

# 1. Actualizar repositorios
echo "[+] Actualizando repositorios..."
apt-get update -qq

# 2. Identificar paquetes vulnerables
echo "[+] Buscando paquetes vulnerables..."
VULN_PKGS=$(apt list --installed | grep -E 'grub2|shim|fwupd' 2>/dev/null)

if [ -z "$VULN_PKGS" ]; then
    echo "[+] No se encontraron paquetes vulnerables"
    exit 0
else
    echo "[!] Paquetes vulnerables encontrados:"
    echo "$VULN_PKGS"
fi

# 3. Actualizar paquetes
echo "[+] Actualizando paquetes..."
apt-get install --only-upgrade -y grub2* shim fwupd

# 4. Configurar GRUB de forma segura
if [ -f "/etc/default/grub" ]; then
    echo "[+] Configurando GRUB de forma segura..."
    sed -i 's/^GRUB_DEFAULT=.*/GRUB_DEFAULT=0/' /etc/default/grub
    sed -i 's/^GRUB_TIMEOUT=.*/GRUB_TIMEOUT=1/' /etc/default/grub
    update-grub
fi

echo "[+] Remedación completada exitosamente"
exit 0