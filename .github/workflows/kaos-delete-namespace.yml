name: Ka0s Delete Namespace & Audit

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Namespace to delete'
        required: true
        type: string
      confirm:
        description: 'Type "DELETE" to confirm'
        required: true
        type: string

permissions:
  contents: write
  issues: write
  actions: write

jobs:
  delete-namespace:
    runs-on: swarm-runners-scaleset
    steps:
      - name: Safety Check
        if: ${{ inputs.confirm != 'DELETE' }}
        run: |
          echo "❌ Confirmation failed. You must type 'DELETE' exactly."
          exit 1

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Execute Force Delete Script
        uses: ./.github/actions/ssh-exec
        with:
          host: ${{ secrets.KAOS_SSH_HOST_1 }}
          username: ${{ secrets.KAOS_SSH_USER }}
          key: ${{ secrets.KAOS_SSH_KEY_PRIV }}
          port: ${{ secrets.KAOS_SSH_PORT_1 }}
          use-sudo: true
          pass: ${{ secrets.KAOS_SSH_PASS }}
          script-path: 'devops/core/k8s/force-delete-namespace.sh'
          script-args: '${{ inputs.namespace }}'
          remote-results-path: '/tmp/results'
          local-results-path: 'audit/trash/'

      - name: Commit Deletion Report
        run: |
          git config --global user.name "Ka0s Bot"
          git config --global user.email "bot@ka0s.io"
          
          # Pull latest changes to avoid conflicts
          git pull --rebase origin main || git pull origin main
          
          git add audit/trash/
          
          if ! git diff --staged --quiet; then
            git commit -m "[Audit] Deleted namespace ${{ inputs.namespace }} - Report $(date +'%Y-%m-%d %H:%M')"
            git push || (git pull --rebase origin main && git push)
          else
            echo "No report generated or already committed."
          fi

  trigger-cluster-status:
    needs: [delete-namespace]
    runs-on: swarm-runners-scaleset
    steps:
      - name: Trigger Audit Cluster Status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Triggering Cluster Status Audit..."
          gh workflow run audit-cluster-status.yml --ref main

  handle-success:
    needs: [trigger-cluster-status]
    if: success()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Log Success
        run: echo "Namespace deletion and audit trigger completed successfully."

  handle-failure:
    name: Handle Failure
    needs: [delete-namespace, trigger-cluster-status, handle-success]
    if: failure()
    runs-on: swarm-runners-scaleset
    steps:
      - id: repo
        name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Create Incident Issue
        env:
          GH_TOKEN: ${{ secrets.KAOS_REPO_TOKEN }}
        run: |
          gh issue create \
            --title "[INCIDENT]: Fallo en workflow ${{ github.workflow }}" \
            --label "itop-incident,triage,automated" \
            --body "### Organización
          Ka0s
          
          ### Proyecto
          ${{ env.KAOS_MODULE }}
          
          ### Fecha
          $(date +'%Y-%m-%d %H:%M:%S')
          
          ### Descripción de la Incidencia
          El workflow **${{ github.workflow }}** ha fallado.
          - **Run ID**: ${{ github.run_id }}
          - **Actor**: ${{ github.actor }}
          - **Evento**: ${{ github.event_name }}
          
          ### Logs y Evidencias
          Por favor revisar los logs de la ejecución: [Run Link](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          "

  end-workflow:
    needs: [handle-success, handle-failure]
    if: always()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Trigger Inspector
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run inspector.yml \
            -f workflow_name="${{ github.workflow }}" \
            -f run_id="${{ github.run_id }}" \
            -f status="${{ job.status }}"
