name: Ka0s Status MongDB Report

on:
  schedule:
    - cron: '10 * * * *'  # Ejecución cada hora en el minuto 10

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write
  
env:
  PYTHON_VERSION: '3.9'
  MONGO_SUPERUSER_CONNECTION: ${{ secrets.DB_CONNECTION_STRING}}
  MONGO_NEW_PASS: ${{ secrets.DB_INITIAL_PASSWORD }}
  MONGO_SCRIPT_CREATE: devops/core/mongo/scripts/mongodb_status_report.py
  KAOS_CODE: ${{ github.run_id }}
  REPORT_SCAN: "audit/"
  REPORT_PATH: audit/mongodb/
  REPORT_FILENAME: ${{ github.run_id }}.json
  KAOS_MODULE: "[Ka0s] Status MongDB Report"

jobs:
  job-core:
    runs-on: swarm-runners-scaleset
    env:
      GITHUB_OUTPUT: ""
    steps:
      - id: repo
        name: Checkout code
        if: ${{ always() }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # token: ${{ secrets.KAOS_REPO_TOKEN }}

      # con esta parte suplimos que la imagen no disponga de la cli de GH    
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install pymongo

      - name: Create database MongoDB
        run: |
         python ${{ env.MONGO_SCRIPT_CREATE }}
         echo "Downloading files to MongoDB update repository ..."
         git config --global user.name "${{ secrets.KAOS_BOT_NAME }}"
         git config --global user.email "${{ secrets.KAOS_BOT_EMAIL }}"
         git pull --rebase
         echo "Uploading files to MongoDB update repository ..."
         git add ${{ env.REPORT_PATH }}
         if ! git diff --staged --quiet; then
            git commit -m "swarm-runners] Uploading files to MongoDB update repository ..."
            git push origin ${{ github.ref }} --force-with-lease
          fi


      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: mongo-setup-report
          path: ${{ env.REPORT_PATH }}

  handle-success:
    runs-on: swarm-runners-scaleset
    needs: [job-core]
    if: ${{ success() }}
    steps:
      - id: repo
        name: Checkout code
        if: ${{ always() }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # token: ${{ secrets.KAOS_REPO_TOKEN }}

      - id: handle-success-execution
        name: handle-success-execution
        env:
          GH_TOKEN: ${{ secrets.KAOS_REPO_TOKEN }}
        run: |
          echo "Process completed successfully ${{ env.KAOS_CODE }}"
  handle-failure:
    name: Handle Failure
    runs-on: swarm-runners-scaleset
    needs: [job-core, handle-success]
    if: failure()
    steps:
      - id: repo
        name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Create Incident Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "[INCIDENT]: Fallo en workflow ${{ github.workflow }}" \
            --label "itop-incident,triage,automated" \
            --body "### Organización
          Ka0s
          
          ### Solicitante
          @${{ github.actor }}
          
          ### Estado
          New
          
          ### Impacto
          Service
          
          ### Urgencia
          Medium
          
          ### Servicio / CI afectado
          GitHub Actions / ${{ github.workflow }}
          
          ### Descripción
          El workflow **${{ github.workflow }}** ha fallado durante su ejecución.
          
          **Detalles Técnicos:**
          - **Módulo**: ${{ env.KAOS_MODULE }}
          - **Run ID**: ${{ github.run_id }}
          - **Commit**: ${{ github.sha }}
          - **Branch/Ref**: ${{ github.ref_name }}
          - **Actor**: ${{ github.actor }}
          
          ### Pasos / Evidencias
          Logs de ejecución: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          "

  end-workflow:
    needs: [handle-success, handle-failure]
    if: always()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Trigger Inspector
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run inspector.yml \
            -f workflow_name="${{ github.workflow }}" \
            -f run_id="${{ github.run_id }}" \
            -f status="${{ job.status }}"
        
