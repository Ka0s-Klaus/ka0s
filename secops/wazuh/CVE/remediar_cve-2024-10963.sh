#!/bin/bash

# Script de remediación para CVE-2024-10963 (vulnerabilidad en pam_access)
# Vulnerabilidad: Interpretación incorrecta de reglas como nombres de host

# Verificar ejecución como root
if [ "$(id -u)" -ne 0 ]; then
    echo "[!] Este script debe ejecutarse como root"
    exit 1
fi

echo "[+] Iniciando remediación para CVE-2024-10963"

# 1. Verificar versión de PAM
pam_version=$(dpkg-query -W -f='${Version}' libpam-runtime 2>/dev/null || rpm -q --queryformat '%{VERSION}' pam 2>/dev/null)
if [ -z "$pam_version" ]; then
    echo "[!] No se pudo determinar la versión de PAM"
else
    echo "  - Versión actual de PAM: $pam_version"
fi

# 2. Actualizar paquetes PAM si es posible
echo "[+] Actualizando paquetes PAM"
if command -v apt-get &> /dev/null; then
    apt-get update && apt-get upgrade -y libpam-modules libpam-runtime
elif command -v yum &> /dev/null; then
    yum update -y pam
else
    echo "[!] No se encontró gestor de paquetes compatible (apt/yum)"
fi

# 3. Configurar opción 'nodns' en pam_access
echo "[+] Configurando opción de mitigación 'nodns'"

# Buscar archivos de configuración pam_access
access_files=("/etc/security/access.conf" "/etc/pam.d/sshd" "/etc/pam.d/login")

for file in "${access_files[@]}"; do
    if [ -f "$file" ]; then
        echo "  - Configurando $file"
        
        # Para access.conf
        if [[ "$file" == "/etc/security/access.conf" ]]; then
            # Agregar comentario de advertencia
            sed -i '1i# Configuración segura para mitigar CVE-2024-10963' "$file"
        fi
        
        # Para archivos PAM
        if grep -q "pam_access.so" "$file"; then
            if ! grep -q "pam_access.so.*nodns" "$file"; then
                sed -i 's/pam_access.so/pam_access.so nodns/' "$file"
                echo "    + Opción 'nodns' agregada"
            else
                echo "    + Opción 'nodns' ya está presente"
            fi
        fi
    else
        echo "  - $file no encontrado (omitido)"
    fi
done

# 4. Recomendaciones adicionales
echo "\n[+] Recomendaciones de seguridad:"
echo "  - Restringir el acceso al archivo /etc/security/access.conf (chmod 600)"
echo "  - Verificar que no haya reglas que puedan ser interpretadas como nombres de host"
echo "  - Monitorear intentos de acceso no autorizados"
echo "  - Considerar implementar autenticación multifactor para servicios críticos"

echo "\n[+] Remediation completada. Se recomienda reiniciar los servicios afectados o el sistema."