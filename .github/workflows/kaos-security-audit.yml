name: 'Ka0s Security Audit'

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * 1' # Every Monday at 08:00 UTC

permissions:
  contents: write
  issues: write
  actions: read

env:
  KAOS_MODULE: "[Ka0S] Security Audit"
  KAOS_CORRELATION_ID: ${{ github.run_id }}
  KAOS_ACTOR: ${{ github.actor }}

jobs:
  audit-cluster:
    name: Audit Kubernetes Security
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Kubectl Tunnel
        uses: ./.github/actions/kubectl-tunnel
        with:
          host: ${{ secrets.KAOS_SSH_HOST_1 }}
          username: ${{ secrets.KAOS_SSH_USER }}
          key: ${{ secrets.KAOS_SSH_KEY_PRIV }}
          port: ${{ secrets.KAOS_SSH_PORT_1 }}

      - name: Run Workload Security Audit
        run: |
          mkdir -p audit/kube
          REPORT_FILE="audit/kube/report-$(date +%Y%m%d-%H%M%S).md"
          echo "REPORT_FILE=$REPORT_FILE" >> $GITHUB_ENV
          
          ./devops/core/k8s/security-audit-workloads.sh "$REPORT_FILE"
          
      - name: Run RBAC & Network Security Audit
        run: |
          ./devops/core/k8s/security-audit-rbac-net.sh "${{ env.REPORT_FILE }}"

      - name: Run Trivy Vulnerability Scan
        run: |
          chmod +x devops/core/k8s/security-audit-trivy.sh
          ./devops/core/k8s/security-audit-trivy.sh "$REPORT_FILE"
      
      - name: Calculate Compliance Score
        run: |
          chmod +x devops/core/k8s/security-audit-score.sh
          ./devops/core/k8s/security-audit-score.sh "$REPORT_FILE"

      - name: Upload Audit Report
        uses: actions/upload-artifact@v4
        with:
          name: k8s-security-report
          path: ${{ env.REPORT_FILE }}

      - name: Commit Audit Report
        run: |
          git config --global user.name "Ka0s Security Bot"
          git config --global user.email "security@ka0s.io"
          
          # Stage and commit first to avoid untracked file conflicts
          git add audit/kube/
          git commit -m "chore(security): add audit report $(date +%Y-%m-%d)"
          
          # Rebase to integrate remote changes
          git pull --rebase origin main
          git push origin main

  handle-success:
    runs-on: swarm-runners-scaleset
    needs: [audit-cluster]
    if: ${{ success() }}
    steps: 
      - id: handle-success-execution
        run: |
          echo "${{ env.KAOS_MODULE }} Success in runid ${{ github.run_id }} initiated."
  handle-failure:
    name: Handle Failure
    needs: [audit-cluster, handle-success]
    if: failure()
    runs-on: swarm-runners-scaleset
    steps:
      - id: repo
        name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Create Incident Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "[INCIDENT]: Fallo en workflow ${{ github.workflow }}" \
            --label "itop-incident,triage,automated" \
            --body "### Organización
          Ka0s
          
          ### Proyecto
          ${{ env.KAOS_MODULE }}
          
          ### Fecha
          $(date +'%Y-%m-%d %H:%M:%S')
          
          ### Descripción de la Incidencia
          El workflow **${{ github.workflow }}** ha fallado.
          - **Run ID**: ${{ github.run_id }}
          - **Actor**: ${{ github.actor }}
          - **Evento**: ${{ github.event_name }}
          
          ### Logs y Evidencias
          Por favor revisar los logs de la ejecución: [Run Link](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          "

  end-workflow:
    needs: [handle-success, handle-failure]
    if: always()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Trigger Inspector
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run inspector.yml \
            -f workflow_name="${{ github.workflow }}" \
            -f run_id="${{ github.run_id }}" \
            -f status="${{ job.status }}"
