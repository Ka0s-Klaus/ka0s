name: 'Ka0s Security Audit'

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * 1' # Every Monday at 08:00 UTC

permissions:
  contents: write

jobs:
  audit-cluster:
    name: Audit Kubernetes Security
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Kubectl Tunnel
        uses: ./.github/actions/kubectl-tunnel
        with:
          host: ${{ secrets.KAOS_SSH_HOST_1 }}
          username: ${{ secrets.KAOS_SSH_USER }}
          key: ${{ secrets.KAOS_SSH_KEY_PRIV }}
          port: ${{ secrets.KAOS_SSH_PORT_1 }}

      - name: Run Workload Security Audit
        run: |
          mkdir -p audit/kube
          REPORT_FILE="audit/kube/report-$(date +%Y%m%d-%H%M%S).md"
          echo "REPORT_FILE=$REPORT_FILE" >> $GITHUB_ENV
          
          ./devops/core/k8s/security-audit-workloads.sh "$REPORT_FILE"
          
      - name: Run RBAC & Network Security Audit
        run: |
          ./devops/core/k8s/security-audit-rbac-net.sh "${{ env.REPORT_FILE }}"

      - name: Run Trivy Vulnerability Scan
        run: |
          ./devops/core/k8s/security-audit-trivy.sh "${{ env.REPORT_FILE }}"
          cat "${{ env.REPORT_FILE }}"

      - name: Upload Audit Report
        uses: actions/upload-artifact@v4
        with:
          name: k8s-security-report
          path: ${{ env.REPORT_FILE }}

      - name: Commit Audit Report
        run: |
          git config --global user.name "Ka0s Security Bot"
          git config --global user.email "security@ka0s.io"
          
          # Stage and commit first to avoid untracked file conflicts
          git add audit/kube/
          git commit -m "chore(security): add audit report $(date +%Y-%m-%d)"
          
          # Rebase to integrate remote changes
          git pull --rebase origin main
          git push origin main
