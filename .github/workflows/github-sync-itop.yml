name: "Ka0s GitHub → iTop Sync"

on:
  issues:
    types: [opened, edited, closed]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  actions: write

env:
  KAOS_MODULE: "[Ka0S] GitHub → iTop Sync"
  KAOS_CORRELATION_ID: ${{ github.run_id }}
  KAOS_ACTOR: ${{ github.actor }}

jobs:
  core-execution:
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Run Sync Script
        id: sync_script
        env:
          ITOP_URL: ${{ secrets.ITOP_URL || vars.ITOP_URL }}
          ITOP_API_USER: ${{ secrets.ITOP_API_USER }}
          ITOP_API_PASSWORD: ${{ secrets.ITOP_API_PASSWORD }}
          ITOP_ORIGIN: ${{ secrets.ITOP_ORIGIN || vars.ITOP_ORIGIN }}
          ITOP_IMPACT_DEPARTMENT: ${{ vars.ITOP_IMPACT_DEPARTMENT }}
          ITOP_IMPACT_SERVICE: ${{ vars.ITOP_IMPACT_SERVICE }}
          ITOP_IMPACT_PERSON: ${{ vars.ITOP_IMPACT_PERSON }}
          ITOP_URGENCY_CRITICAL: ${{ vars.ITOP_URGENCY_CRITICAL }}
          ITOP_URGENCY_HIGH: ${{ vars.ITOP_URGENCY_HIGH }}
          ITOP_URGENCY_MEDIUM: ${{ vars.ITOP_URGENCY_MEDIUM }}
          ITOP_URGENCY_LOW: ${{ vars.ITOP_URGENCY_LOW }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_ACTION: ${{ github.event.action }}
          GITHUB_ISSUE_PAYLOAD: ${{ toJSON(github.event.issue) }}
          GITHUB_COMMENT_PAYLOAD: ${{ toJSON(github.event.comment) }}
          GITHUB_REPO_FULL_NAME: ${{ github.repository }}
        run: python .github/scripts/github-sync-itop.py > result.json

      - name: Save audit log
        id: save_audit # Damos un ID a este paso
        if: always() # Siempre se ejecuta
        run: |
          # Si result.json no existe o está vacío, no hacemos nada.
          if [ ! -s result.json ]; then
            echo "result.json no encontrado o vacío. No se creará log de auditoría."
            # Establecemos una salida para que el siguiente paso sepa que no debe ejecutarse
            echo "audit_file_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Instalamos jq para leer el JSON de forma segura
          sudo apt-get install -y jq
          
          mkdir -p audit/sync
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          # Extraemos el número de issue del JSON de forma segura
          ISSUE_ID=$(jq -r '.github_ref | split("/")[-1] // "NOREF"' result.json)
          # Intentamos obtener la referencia de iTop (ref) de la respuesta; si no existe, caemos a itop_key; si no, unknown
          ITOP_REF=$(jq -r '
            (try (.create.response.objects | to_entries[0].value.fields.ref) catch empty) //
            (try (.update.response.objects | to_entries[0].value.fields.ref) catch empty) //
            (try (.close.response.objects  | to_entries[0].value.fields.ref) catch empty) //
            .itop_key // "NOREF"' result.json)
          # Saneamos la ref para nombre de fichero
          SAFE_ITOP_REF=$(echo "$ITOP_REF" | tr ' /:\\' '____')
          # Nuevo esquema: <timestamp>_<itop_ref>_<issue>.json
          FILENAME="audit/sync/${TIMESTAMP}_${SAFE_ITOP_REF}_${ISSUE_ID}.json"
          
          mv result.json $FILENAME

          # Si hay error en la llamada a iTop, generamos además un fichero de error explícito
          HAS_ERROR=$(jq -r '
            if (.status? == "error") then "true"
            elif (.create?.status? == "error") then "true"
            elif (.update?.status? == "error") then "true"
            elif (.close?.status? == "error") then "true"
            else "false" end
          ' "$FILENAME")

          if [ "$HAS_ERROR" = "true" ]; then
            ERROR_FILENAME="audit/sync/${TIMESTAMP}_${SAFE_ITOP_REF}_${ISSUE_ID}_ERROR.json"
            cp "$FILENAME" "$ERROR_FILENAME"
          fi
          
          echo "AUDIT_FILE=$FILENAME" >> $GITHUB_ENV
          echo "audit_file_created=true" >> $GITHUB_OUTPUT

      - name: Commit and push audit file
        if: steps.save_audit.outputs.audit_file_created == 'true' # Solo se ejecuta si el paso anterior creó un fichero
        run: |
          git config --global user.name "${{ secrets.KAOS_BOT_NAME || 'Ka0s Bot' }}"
          git config --global user.email "${{ secrets.KAOS_BOT_EMAIL || 'bot@ka0s.io' }}"
          git pull
          git add audit/sync/*
          if ! git diff --staged --quiet; then
            git commit -m "chore(ka0s): audit sync for issue #${{ github.event.issue.number }} run ${{ env.KAOS_CORRELATION_ID }} [skip ci]"
            count=0
            until git push origin HEAD:${{ github.ref_name }} || [ $count -eq 5 ]; do
              echo "Push fallido, reintentando..."
              git pull --rebase origin ${{ github.ref_name }}
              ((count++))
              sleep 2
            done
          else
            echo "No hay cambios para subir."
          fi

  handle-success:
    name: Handle Success
    needs: [core-execution]
    if: success()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Notify Success
        run: echo "✅ Workflow ${{ env.KAOS_MODULE }} completado correctamente."

  handle-failure:
    name: Handle Failure
    needs: [core-execution, handle-success]
    if: failure()
    runs-on: swarm-runners-scaleset
    steps:
      - id: repo
        name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Create Incident Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "[INCIDENT]: Fallo en workflow ${{ github.workflow }}" \
            --label "itop-incident,triage,automated" \
            --body "### Organización
          Ka0s
          
          ### Proyecto
          ${{ env.KAOS_MODULE }}
          
          ### Fecha
          $(date +'%Y-%m-%d %H:%M:%S')
          
          ### Descripción de la Incidencia
          El workflow **${{ github.workflow }}** ha fallado.
          - **Run ID**: ${{ github.run_id }}
          - **Actor**: ${{ github.actor }}
          - **Evento**: ${{ github.event_name }}
          
          ### Logs y Evidencias
          Por favor revisar los logs de la ejecución: [Run Link](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          "

  end-workflow:
    needs: [handle-success, handle-failure]
    if: always()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Trigger Inspector
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run inspector.yml \
            -f workflow_name="${{ github.workflow }}" \
            -f run_id="${{ github.run_id }}" \
            -f status="${{ job.status }}"
