name: iTop Sync from GitHub Issue

on:
  issues:
    types: [opened, edited, closed]
  issue_comment:
    types: [created]

jobs:
  sync-to-itop:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Run Sync Script
        id: sync_script
        continue-on-error: true # Permite que el workflow continúe si este paso falla
        env:
          ITOP_URL: ${{ secrets.ITOP_URL }}
          ITOP_API_USER: ${{ secrets.ITOP_API_USER }}
          ITOP_API_PASSWORD: ${{ secrets.ITOP_API_PASSWORD }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_ACTION: ${{ github.event.action }}
          GITHUB_ISSUE_PAYLOAD: ${{ toJSON(github.event.issue) }}
          GITHUB_COMMENT_PAYLOAD: ${{ toJSON(github.event.comment) }}
          GITHUB_REPO_FULL_NAME: ${{ github.repository }}
        run: python .github/scripts/github-sync-itop.py > result.json

      - name: Save audit log
        id: save_audit # Damos un ID a este paso
        if: always() # Siempre se ejecuta
        run: |
          # Si result.json no existe o está vacío, no hacemos nada.
          if [ ! -s result.json ]; then
            echo "result.json no encontrado o vacío. No se creará log de auditoría."
            # Establecemos una salida para que el siguiente paso sepa que no debe ejecutarse
            echo "audit_file_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Instalamos jq para leer el JSON de forma segura
          sudo apt-get install -y jq
          
          mkdir -p audit/sync
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          # Usamos jq para extraer el número de issue del JSON de forma segura
          ISSUE_ID=$(jq -r '.github_ref | split("/")[-1] // "unknown"' result.json)
          FILENAME="audit/sync/${TIMESTAMP}_issue_${ISSUE_ID}.json"
          
          mv result.json $FILENAME
          
          echo "AUDIT_FILE=$FILENAME" >> $GITHUB_ENV
          echo "audit_file_created=true" >> $GITHUB_OUTPUT

      - name: Commit and push audit file
        if: steps.save_audit.outputs.audit_file_created == 'true' # Solo se ejecuta si el paso anterior creó un fichero
        run: |
          git config --global user.name "Ka0s Bot"
          git config --global user.email "bot@ka0s.io"
          git add ${{ env.AUDIT_FILE }}
          # El '|| true' evita que el workflow falle si no hay nada que commitear (aunque no debería pasar)
          git diff --staged --quiet || git commit -m "AUDIT: Add sync log for issue #${{ github.event.issue.number }}"
          git push
