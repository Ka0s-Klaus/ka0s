name: Watchdog - Node Health
on:
  schedule:
    - cron: '0 * * * *'  # Run every hour
  workflow_dispatch:

permissions:
  actions: write
  contents: read
  issues: write

env:
  KAOS_MODULE: "[Ka0S] Watchdog Node Health"

jobs:
  job-core:
    runs-on: swarm-runners-scaleset
    outputs:
      affected_nodes: ${{ steps.check.outputs.nodes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Setup Kubectl Tunnel
        uses: ./.github/actions/kubectl-tunnel
        with:
          host: ${{ secrets.KAOS_SSH_HOST_1 }}
          username: ${{ secrets.KAOS_SSH_USER }}
          key: ${{ secrets.KAOS_SSH_KEY_PRIV }}
          port: ${{ secrets.KAOS_SSH_PORT_1 }}

      - name: Detect Unhealthy Nodes
        id: check
        run: |
          chmod +x .github/scripts/watchdog-disk-pressure.py
          NODES=$(python3 .github/scripts/watchdog-disk-pressure.py)
          
          if [ -z "$NODES" ]; then
            echo "‚úÖ All nodes are healthy (No DiskPressure)."
            echo "nodes=" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Found nodes with DiskPressure:"
            echo "$NODES"
            # Replace newlines with spaces or keep as multiline for output? 
            # Multiline strings in output are tricky. Let's use JSON or just space separated.
            # For loop below handles space separated fine if names don't have spaces.
            NODES_FLAT=$(echo "$NODES" | tr '\n' ' ')
            echo "nodes=$NODES_FLAT" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Isolation Protocol
        if: steps.check.outputs.nodes != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NODES="${{ steps.check.outputs.nodes }}"
          for NODE in $NODES; do
            echo "üö® Triggering isolation for node: $NODE"
            gh workflow run ops-node-management.yml \
              --ref main \
              -f node_name="$NODE" \
              -f action="cordon"
          done

  handle-success:
    needs: [job-core]
    if: success()
    runs-on: swarm-runners-scaleset
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Log Success
        run: echo "Watchdog scan completed successfully."

      - id: repo
        name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli

      - name: Trigger Cluster Audit
        run: |
          echo "üì∏ Triggering post-watchdog cluster audit..."
          gh workflow run audit-cluster-status.yml --ref main


  handle-failure:
    name: Handle Failure
    needs: [job-core] # Nota: handle-success no es necesario aqu√≠ como dependencia si no se encadena
    if: failure()
    runs-on: swarm-runners-scaleset
    steps:
      - id: repo
        name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Create Incident Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "[INCIDENT]: Fallo en workflow ${{ github.workflow }}" \
            --label "itop-incident,triage,automated" \
            --body "### Organizaci√≥n
          Ka0s
          
          ### Solicitante
          @${{ github.actor }}
          
          ### Estado
          New
          
          ### Impacto
          Service
          
          ### Urgencia
          Medium
          
          ### Servicio / CI afectado
          GitHub Actions / ${{ github.workflow }}
          
          ### Descripci√≥n
          El workflow **${{ github.workflow }}** ha fallado durante su ejecuci√≥n.
          
          **Detalles T√©cnicos:**
          - **M√≥dulo**: ${{ env.KAOS_MODULE }}
          - **Run ID**: ${{ github.run_id }}
          - **Commit**: ${{ github.sha }}
          - **Branch/Ref**: ${{ github.ref_name }}
          - **Actor**: ${{ github.actor }}
          
          ### Pasos / Evidencias
          Logs de ejecuci√≥n: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          "

  end-workflow:
    needs: [handle-success, handle-failure]
    if: always()
    runs-on: swarm-runners-scaleset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GH CLI
        uses: ./.github/actions/install-gh-cli
      - name: Trigger Inspector
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run inspector.yml \
            -f workflow_name="${{ github.workflow }}" \
            -f run_id="${{ github.run_id }}" \
            -f status="${{ job.status }}"
