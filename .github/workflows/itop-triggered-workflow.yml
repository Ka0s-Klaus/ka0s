name: Ka0s iTop Triggered Workflow

on:
  workflow_dispatch:
    inputs:
      itop_ticket_id:
        description: 'ID del ticket de iTop'
        required: true
        default: 'N/A'
      requester_name:
        description: 'Nombre del solicitante'
        required: true
        default: 'Ka0sC0re'

jobs:
  job-core:
    runs-on: swarm-runners-scaleset
    steps:
      - name: Print iTop Data
        run: |
          echo "Workflow iniciado desde iTop."
          echo "ID del Ticket: ${{ github.event.inputs.itop_ticket_id }}"
          echo "Solicitante: ${{ github.event.inputs.requester_name }}"

      - name: Checkout code
        uses: actions/checkout@v4

      # Aquí irían los pasos de tu automatización en ejecuciones futuras
      # Por ejemplo, ejecutar un script, desplegar una aplicación, etc.
      - name: Run automation script
        run: echo "Ejecutando la tarea automatizada..."

  update-itop-on-success:
    runs-on: swarm-runners-scaleset
    needs: job-core
    if: success()
    steps:
      - name: Close iTop Ticket on Success
        run: |
          curl -k -X POST "${{ secrets.ITOP_URL }}/webservices/rest.php?version=1.3" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -u "${{ secrets.ITOP_API_USER }}:${{ secrets.ITOP_API_PASSWORD }}" \
          --data-urlencode 'json_data={
            "operation": "core/update",
            "class": "UserRequest",
            "key": "SELECT UserRequest WHERE id = ${{ github.event.inputs.itop_ticket_id }}",
            "output_fields": "id",
            "fields": {
              "status": "closed",
              "private_log": {
                "message": "El workflow de GitHub ha finalizado con éxito. El requerimiento se cierra automáticamente."
              }
            }
          }'

  update-itop-on-failure:
    runs-on: swarm-runners-scaleset
    needs: job-core
    if: failure()
    steps:
      - name: Update iTop Ticket on Failure
        run: |
          ERROR_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -k -X POST "${{ secrets.ITOP_URL }}/webservices/rest.php?version=1.3" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -u "${{ secrets.ITOP_API_USER }}:${{ secrets.ITOP_API_PASSWORD }}" \
          --data-urlencode "json_data={
            \"operation\": \"core/update\",
            \"class\": \"UserRequest\",
            \"key\": \"SELECT UserRequest WHERE id = ${{ github.event.inputs.itop_ticket_id }}\",
            \"output_fields\": \"id\",
            \"fields\": {
              \"private_log\": {
                \"message\": \"El workflow de GitHub ha fallado. Por favor, revise los logs para más detalles: ${ERROR_URL}\"
              }
            }
          }"