name: iTop Sync from GitHub Issue

on:
  issues:
    types: [opened, edited, closed]
  issue_comment:
    types: [created]

jobs:
  sync-to-itop:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Run Sync Script
        id: sync_script
        # Añadimos 'continue-on-error' para que el job no se marque como fallido inmediatamente
        continue-on-error: true 
        env:
          # ... (tus variables de entorno)
        run: python .github/scripts/github-sync-itop.py > result.json

      - name: Save audit log
        # Este paso se ejecutará siempre, incluso si el script falló
        if: always()
        run: |
          # Comprobamos si el fichero de resultado existe y no está vacío
          if [ ! -s result.json ]; then
            echo "result.json no encontrado o vacío. No se creará log de auditoría."
            exit 0
          fi
          mkdir -p audit/sync
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          ISSUE_ID=$(jq -r '.github_ref | split("/")[-1]' result.json || echo "unknown")
          FILENAME="audit/sync/${TIMESTAMP}_issue_${ISSUE_ID}.json"
          mv result.json $FILENAME
          echo "AUDIT_FILE=$FILENAME" >> $GITHUB_ENV

      - name: Commit and push audit file
        # Este paso también se ejecutará siempre
        if: always()
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add ${{ env.AUDIT_FILE }}
          git diff --staged --quiet || git commit -m "AUDIT: Add sync log for issue #${{ fromJson(steps.sync_script.outputs.json).github_ref | split('/')[-1] || github.event.issue.number }}"
          git push
