name: Ka0s iTop Triggered Workflow

on:
  workflow_dispatch:
    inputs:
      itop_ticket_id:
        description: 'ID del ticket de iTop'
        required: true
        default: 'N/A'
      requester_name:
        description: 'Nombre del solicitante'
        required: true
        default: 'Ka0sC0re'

jobs:
  job-core:
    runs-on: swarm-runners-scaleset
    outputs:
      status: ${{ job.status }}
    steps:
      - name: Print iTop Data
        run: |
          echo "Workflow iniciado desde iTop."
          echo "ID del Ticket: ${{ github.event.inputs.itop_ticket_id }}"
          echo "Solicitante: ${{ github.event.inputs.requester_name }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run automation script
        id: automation
        run: |
          echo "Ejecutando la tarea automatizada..."
          # exit 1 # Uncomment to test failure case

  update-itop:
    runs-on: swarm-runners-scaleset
    needs: job-core
    if: always()
    steps:
      - name: Update iTop on Success
        if: needs.job-core.result == 'success'
        env:
          ITOP_URL: ${{ secrets.ITOP_URL || vars.ITOP_URL }}
          ITOP_USER: ${{ secrets.ITOP_API_USER }}
          ITOP_PASSWORD: ${{ secrets.ITOP_API_PASSWORD }}
        run: |
          if [ -z "$ITOP_URL" ]; then
            echo "::error::La variable ITOP_URL no se encuentra en Secrets ni en Variables."
            exit 1
          fi
          
          JSON_PAYLOAD=$(cat <<EOF
          {
            "operation": "core/apply_stimulus",
            "class": "UserRequest",
            "key": "${{ github.event.inputs.itop_ticket_id }}",
            "stimulus": "ev_resolve",
            "comment": "Ticket resuelto automáticamente por GitHub Actions.",
            "fields": {
              "solution": "La automatización se ejecutó correctamente.",
              "agent_id": "SELECT Person JOIN User ON User.contactid = Person.id WHERE User.login = '${ITOP_USER}'"
            }
          }
          EOF
          )
          echo "::group::Resolviendo Ticket en iTop..."
          curl -k -X POST "${ITOP_URL}/webservices/rest.php?version=1.3" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -u "${ITOP_USER}:${ITOP_PASSWORD}" \
          --data-urlencode "json_data=$JSON_PAYLOAD"
          echo "::endgroup::"

          # Paso 2: Cerrar el ticket (ev_close)
          JSON_PAYLOAD_CLOSE=$(cat <<EOF
          {
            "operation": "core/apply_stimulus",
            "class": "UserRequest",
            "key": "${{ github.event.inputs.itop_ticket_id }}",
            "stimulus": "ev_close",
            "comment": "Cierre automático post-resolución.",
            "fields": {
              "user_satisfaction": 4,
              "user_comment": "Cerrado automáticamente por GitHub Actions."
            }
          }
          EOF
          )
          echo "::group::Cerrando Ticket en iTop..."
          curl -k -X POST "${ITOP_URL}/webservices/rest.php?version=1.3" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -u "${ITOP_USER}:${ITOP_PASSWORD}" \
          --data-urlencode "json_data=$JSON_PAYLOAD_CLOSE"
          echo "::endgroup::"

      - name: Update iTop on Failure
        if: needs.job-core.result == 'failure'
        env:
          ITOP_URL: ${{ secrets.ITOP_URL || vars.ITOP_URL }}
          ITOP_USER: ${{ secrets.ITOP_API_USER }}
          ITOP_PASSWORD: ${{ secrets.ITOP_API_PASSWORD }}
        run: |
          if [ -z "$ITOP_URL" ]; then
            echo "::error::La variable ITOP_URL no se encuentra en Secrets ni en Variables."
            exit 1
          fi

          ERROR_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # 1. Resolver el ticket indicando el fallo
          JSON_PAYLOAD=$(cat <<EOF
          {
            "operation": "core/apply_stimulus",
            "class": "UserRequest",
            "key": "${{ github.event.inputs.itop_ticket_id }}",
            "stimulus": "ev_resolve",
            "comment": "El workflow de GitHub ha fallado.",
            "fields": {
              "solution": "La automatización falló. Por favor, revise los logs para más detalles: ${ERROR_URL}",
              "agent_id": "SELECT Person JOIN User ON User.contactid = Person.id WHERE User.login = '${ITOP_USER}'",
              "public_log": {
                "add_item": {
                  "message": "El workflow de GitHub ha fallado. Por favor, revise los logs para más detalles: ${ERROR_URL}",
                  "format": "text"
                }
              }
            }
          }
          EOF
          )
          echo "::group::Resolviendo Ticket (Fallo)..."
          curl -k -X POST "${ITOP_URL}/webservices/rest.php?version=1.3" \
          --header "Content-Type: application/x-www-form-urlencoded" \
          -u "${ITOP_USER}:${ITOP_PASSWORD}" \
          --data-urlencode "json_data=$JSON_PAYLOAD"
          echo "::endgroup::"

          # 2. Cerrar el ticket con insatisfacción (1 = Very Dissatisfied)
          JSON_PAYLOAD_CLOSE=$(cat <<EOF
          {
            "operation": "core/apply_stimulus",
            "class": "UserRequest",
            "key": "${{ github.event.inputs.itop_ticket_id }}",
            "stimulus": "ev_close",
            "comment": "Cierre automático por fallo de automatización.",
            "fields": {
              "user_satisfaction": 1,
              "user_comment": "El proceso automático falló. Revisar logs."
            }
          }
          EOF
          )
          echo "::group::Cerrando Ticket (Fallo)..."
          curl -k -X POST "${ITOP_URL}/webservices/rest.php?version=1.3" \
          --header "Content-Type: application/x-www-form-urlencoded" \
          -u "${ITOP_USER}:${ITOP_PASSWORD}" \
          --data-urlencode "json_data=$JSON_PAYLOAD_CLOSE"
          echo "::endgroup::"
